<template>
  <div>
    <n-card :bordered="false" class="h-full rounded-8px shadow-sm">
      <div class="flex flex-col space-y-4 mb-4">
        <div class="flex justify-between">
          <h2 class="text-xl font-bold">STRMÂ§ÑÁêÜ‰ªªÂä°ÁÆ°ÁêÜ</h2>
          <n-space>
            <n-button type="primary" @click="goToGenerate">Êñ∞Âª∫STRM‰ªªÂä°</n-button>
          </n-space>
        </div>

        <div class="flex flex-wrap items-center gap-2">
          <n-input v-model:value="searchValue" placeholder="ÊêúÁ¥¢‰ªªÂä°ÂêçÁß∞..." clearable style="width: 200px"
            @keyup.enter="handleSearch" />

          <n-date-picker v-model:value="dateRange" type="daterange" clearable style="width: 260px" placeholder="ÈÄâÊã©Êó∂Èó¥ËåÉÂõ¥"
            :shortcuts="dateShortcuts" />

          <n-select v-model:value="statusFilter" placeholder="‰ªªÂä°Áä∂ÊÄÅ" clearable style="width: 150px"
            :options="statusOptions" />

          <n-button type="primary" size="medium" style="width: 80px; height: 34px;" @click="handleSearch">
            ÊêúÁ¥¢
          </n-button>

          <n-button size="medium" style="height: 34px;" @click="clearFilters">
            Ê∏ÖÈô§Á≠õÈÄâ
          </n-button>

          <!-- Ëá™Âä®Âà∑Êñ∞ÊéßÂà∂ -->
          <div class="auto-refresh-control">
            <n-tooltip trigger="hover" placement="top">
              <template #trigger>
                <n-switch
                  v-model:value="autoRefreshEnabled"
                  @update:value="toggleAutoRefresh"
                  size="medium"
                >
                  <template #checked>
                    <n-icon size="16">
                      <Icon icon="mdi:refresh" />
                    </n-icon>
                  </template>
                  <template #unchecked>
                    <n-icon size="16">
                      <Icon icon="mdi:refresh-off" />
                    </n-icon>
                  </template>
                </n-switch>
              </template>
              <div style="max-width: 200px;">
                <div style="font-weight: 600; margin-bottom: 4px;">Ëá™Âä®Âà∑Êñ∞ÂäüËÉΩ</div>
                <div style="font-size: 12px; line-height: 1.4;">
                  ÂºÄÂêØÂêéÔºåÊåâËÆæÂÆöÁöÑÈó¥ÈöîÊó∂Èó¥Ëá™Âä®Êõ¥Êñ∞‰ªªÂä°ÂàóË°®„ÄÇ
                </div>
              </div>
            </n-tooltip>

            <!-- Âà∑Êñ∞Èó¥ÈöîËÆæÁΩÆ -->
            <n-select
              v-model:value="refreshInterval"
              @update:value="updateRefreshInterval"
              size="small"
              style="width: 80px;"
              :options="refreshIntervalOptions"
            />

            <div class="refresh-status">
              <span class="refresh-label">Ëá™Âä®Âà∑Êñ∞</span>
              <span v-if="autoRefreshEnabled" class="refresh-countdown">
                {{ refreshCountdown }}s
              </span>
              <span v-else class="refresh-disabled">
                Â∑≤ÂÖ≥Èó≠
              </span>
            </div>
          </div>
        </div>
      </div>

      <n-data-table :columns="columns" :data="tasksData" :loading="loading" :pagination="{
        page: pagination.page,
        pageSize: pagination.pageSize,
        showSizePicker: true,
        pageSizes: [10, 20, 50, 100],
        itemCount: pagination.itemCount,
        prefix: ({ itemCount }) => `ÂÖ± ${itemCount} Êù°`,
        showQuickJumper: true
      }" remote :row-key="row => row.id" @update:page="handlePageChange" @update:page-size="handlePageSizeChange" />
    </n-card>

    <!-- ‰ªªÂä°ËØ¶ÊÉÖÂØπËØùÊ°Ü -->
    <n-modal v-model:show="showTaskDetailModal" preset="card" :bordered="false" size="huge"
      style="max-width: 1200px; width: 95vw; margin-top: 20px">
      <template #header>
        <div class="task-detail-header">
          <div class="task-header-main">
            <div class="task-title">
              <span class="task-icon">‚öôÔ∏è</span>
              <span class="task-name">{{ currentTask?.name || '‰ªªÂä°ËØ¶ÊÉÖ' }}</span>
            </div>
          </div>
        </div>
      </template>

      <div v-if="currentTask" class="task-detail-container">

        <n-tabs type="line" animated class="task-detail-tabs" @update:value="handleTabChange">
          <n-tab-pane name="overview" tab="üìä ‰ªªÂä°Ê¶ÇËßà">

            <!-- ÈáçÊûÑÂêéÁöÑ‰ªªÂä°ËØ¶ÁªÜ‰ø°ÊÅØ -->
            <div class="task-info-section">
              <div class="section-title-wrapper">
                <h3 class="section-title">
                  <div class="title-icon-wrapper">
                    <n-icon size="20">
                      <Icon icon="mdi:information-variant" />
                    </n-icon>
                  </div>
                  <span>‰ªªÂä°ËØ¶ÁªÜ‰ø°ÊÅØ</span>
                </h3>
              </div>

              <!-- ÈáçÊñ∞Âπ≥Ë°°ÁöÑ‰ø°ÊÅØÂç°ÁâáÁΩëÊ†º -->
              <div class="enhanced-info-grid">
                <!-- Âü∫Êú¨ÈÖçÁΩÆÂç°Áâá -->
                <div class="info-card primary-card">
                  <div class="card-header">
                    <div class="card-icon primary-icon">
                      <n-icon size="24">
                        <Icon icon="mdi:cog" />
                      </n-icon>
                    </div>
                    <div class="card-title">
                      <h4>Âü∫Êú¨ÈÖçÁΩÆ</h4>
                      <span class="card-subtitle">‰ªªÂä°Âü∫Á°ÄËÆæÁΩÆ‰ø°ÊÅØ</span>
                    </div>
                  </div>
                  <div class="card-content">
                    <div class="info-row">
                      <div class="info-label">
                        <n-icon size="16">
                          <Icon icon="mdi:identifier" />
                        </n-icon>
                        ‰ªªÂä°ID
                      </div>
                      <n-tag size="small" type="info" :bordered="false">
                        üÜî ID: {{ currentTask?.id }}
                      </n-tag>
                    </div>
                    <div class="info-row">
                      <div class="info-label">
                        <n-icon size="16">
                          <Icon icon="mdi:format-title" />
                        </n-icon>
                        ‰ªªÂä°ÂêçÁß∞
                      </div>
                      <div class="info-value">{{ currentTask.name || `‰ªªÂä° ${currentTask.id}` }}</div>
                    </div>
                    <div class="info-row">
                      <div class="info-label">
                        <n-icon size="16">
                          <Icon icon="mdi:state-machine" />
                        </n-icon>
                        ‰ªªÂä°Áä∂ÊÄÅ
                      </div>
                      <div class="info-value">
                        <TaskStatusDisplay :status="currentTask?.status" :taskType="currentTask?.task_type" />
                      </div>
                    </div>
                    <div class="info-row">
                      <div class="info-label">
                        <n-icon size="16">
                          <Icon icon="mdi:cpu-64-bit" />
                        </n-icon>
                        Â§ÑÁêÜÁ∫øÁ®ã
                      </div>
                      <div class="info-value">{{ currentTask.threads || 1 }}</div>
                    </div>
                    <div class="info-row full-width">
                      <div class="info-label">
                        <n-icon size="16">
                          <Icon icon="mdi:folder-outline" />
                        </n-icon>
                        ËæìÂá∫ÁõÆÂΩï
                      </div>
                      <div class="enhanced-output-dir">
                        <div class="path-display-container">
                          <div class="path-icon">
                            <n-icon size="18" color="#1890ff">
                              <Icon icon="mdi:folder-open" />
                            </n-icon>
                          </div>
                          <div class="path-content">
                            <div class="path-text" :title="currentTask.output_dir">
                              {{ currentTask.output_dir || 'ÈªòËÆ§ËæìÂá∫ÁõÆÂΩï' }}
                            </div>
                            <div class="path-actions">
                              <n-button
                                size="tiny"
                                type="primary"
                                text
                                @click="copyOutputDir"
                                :disabled="!currentTask.output_dir"
                                class="copy-action"
                              >
                                <template #icon>
                                  <n-icon size="14">
                                    <Icon icon="mdi:content-copy" />
                                  </n-icon>
                                </template>
                                Â§çÂà∂Ë∑ØÂæÑ
                              </n-button>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- ÊâßË°å‰∏éÊúçÂä°Âô®‰ø°ÊÅØÂç°Áâá -->
                <div class="info-card time-card">
                  <div class="card-header">
                    <div class="card-icon time-icon">
                      <n-icon size="24">
                        <Icon icon="mdi:server-network" />
                      </n-icon>
                    </div>
                    <div class="card-title">
                      <h4>ÊâßË°å‰∏éÊúçÂä°Âô®‰ø°ÊÅØ</h4>
                      <span class="card-subtitle">‰ªªÂä°ÊâßË°åÊó∂Èó¥‰∏éÊúçÂä°Âô®ÈÖçÁΩÆ</span>
                    </div>
                  </div>
                  <div class="card-content">
                    <div class="info-row">
                      <div class="info-label">
                        <n-icon size="16">
                          <Icon icon="mdi:play-circle" />
                        </n-icon>
                        ÂºÄÂßãÊó∂Èó¥
                      </div>
                      <div class="info-value time-value">
                        {{ currentTask.start_time ? formatDate(currentTask.start_time) : 'Â∞öÊú™ÂºÄÂßã' }}
                      </div>
                    </div>
                    <div class="info-row">
                      <div class="info-label">
                        <n-icon size="16">
                          <Icon icon="mdi:check-circle" />
                        </n-icon>
                        ÂÆåÊàêÊó∂Èó¥
                      </div>
                      <div class="info-value time-value">
                        {{ currentTask.end_time ? formatDate(currentTask.end_time) : 'Â∞öÊú™ÂÆåÊàê' }}
                      </div>
                    </div>
                    <div class="info-row">
                      <div class="info-label">
                        <n-icon size="16">
                          <Icon icon="mdi:timer" />
                        </n-icon>
                        Â§ÑÁêÜÊó∂Èïø
                      </div>
                      <div class="info-value duration-value"
                        :class="{ 'processing-status': isTaskProcessing(currentTask) }">
                        {{ getTaskDuration(currentTask) }}
                      </div>
                    </div>
                    <div class="info-row">
                      <div class="info-label">
                        <n-icon size="16">
                          <Icon icon="mdi:server" />
                        </n-icon>
                        Â™í‰ΩìÊúçÂä°Âô®
                      </div>
                      <div class="info-value server-url">{{ currentTask.server_url || 'Êú™Áü•ÊúçÂä°Âô®' }}</div>
                    </div>
                    <div class="info-row">
                      <div class="info-label">
                        <n-icon size="16">
                          <Icon icon="mdi:download-network" />
                        </n-icon>
                        ‰∏ãËΩΩÊúçÂä°Âô®
                      </div>
                      <div class="info-value server-url">
                        {{ currentTask.download_server_url || currentTask.server_url || 'Êú™Áü•ÊúçÂä°Âô®' }}
                        <span v-if="!currentTask.download_server_url" class="server-note">Ôºà‰∏éÂ™í‰ΩìÊúçÂä°Âô®Áõ∏ÂêåÔºâ</span>
                      </div>
                    </div>
                    <div class="info-row">
                      <div class="info-label">
                        <n-icon size="16">
                          <Icon icon="mdi:harddisk" />
                        </n-icon>
                        ËµÑÊ∫êÂ§ßÂ∞è
                      </div>
                      <div class="info-value">{{ formatFileSize(currentTask.total_size || 0) }}</div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Êñá‰ª∂ÁªüËÆ°‰∏éÂ§ÑÁêÜËøõÂ∫¶ -->
            <div class="progress-stats-section">
              <h3 class="section-title">
                <n-icon>
                  <Icon icon="mdi:chart-line" />
                </n-icon>
                Êñá‰ª∂ÁªüËÆ°
              </h3>

              <div class="progress-stats-grid">
                <!-- ÊÄª‰ΩìËøõÂ∫¶Âç°Áâá -->
                <div class="progress-card overall">
                  <div class="progress-card-header">
                    <div class="progress-card-icon">
                      <n-icon size="24">
                        <Icon icon="mdi:chart-pie" />
                      </n-icon>
                    </div>
                    <div class="progress-card-title">
                      <h4>ÊÄª‰ΩìËøõÂ∫¶</h4>
                      <span class="progress-card-subtitle">{{ getTotalProcessedFiles(currentTask) }} / {{
                        currentTask.total_files
                        || 0 }} Êñá‰ª∂</span>
                    </div>
                    <div class="progress-card-percentage">
                      {{ getTaskProgressPercentage(currentTask) }}%
                    </div>
                  </div>
                  <div class="progress-card-body">
                    <SegmentedProgressBar
                      :success-count="getTotalSuccessFiles(currentTask)"
                      :failed-count="getTotalFailedFiles(currentTask)"
                      :total="currentTask.total_files || 0"
                      :processing="currentTask.status === 'RUNNING'"
                      :height="8"
                      :border-radius="4"
                      success-color="#52c41a"
                      failed-color="#f5222d"
                      tooltip-title="ÊÄª‰ΩìÊñá‰ª∂Â§ÑÁêÜËøõÂ∫¶"
                    />
                    <div class="progress-card-stats">
                      <div class="stat-item">
                        <span class="stat-label">ÊàêÂäü</span>
                        <span class="stat-value success">{{ getTotalSuccessFiles(currentTask) }}</span>
                      </div>
                      <div class="stat-item">
                        <span class="stat-label">Â§±Ë¥•</span>
                        <span class="stat-value error">{{ getTotalFailedFiles(currentTask) }}</span>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- STRMÊñá‰ª∂ËøõÂ∫¶Âç°Áâá -->
                <div class="progress-card strm">
                  <div class="progress-card-header">
                    <div class="progress-card-icon">
                      <n-icon size="24">
                        <Icon icon="mdi:file-video" />
                      </n-icon>
                    </div>
                    <div class="progress-card-title">
                      <h4>STRMÊñá‰ª∂</h4>
                      <span class="progress-card-subtitle">{{ (currentTask.strm_success || 0) + (currentTask.strm_failed || 0) }} / {{
                        currentTask.strm_files_count || 0 }} Êñá‰ª∂</span>
                    </div>
                    <div class="progress-card-percentage">
                      {{ getStrmProgressPercentage(currentTask) }}%
                    </div>
                  </div>
                  <div class="progress-card-body">
                    <SegmentedProgressBar
                      :success-count="currentTask.strm_success || 0"
                      :failed-count="currentTask.strm_failed || 0"
                      :total="currentTask.strm_files_count || 0"
                      :processing="currentTask.status === 'RUNNING'"
                      :height="8"
                      :border-radius="4"
                      success-color="#52c41a"
                      failed-color="#f5222d"
                      tooltip-title="STRMÊñá‰ª∂Â§ÑÁêÜËøõÂ∫¶"
                    />
                    <div class="progress-card-stats">
                      <div class="stat-item">
                        <span class="stat-label">ÊàêÂäü</span>
                        <span class="stat-value success">{{ currentTask.strm_success || 0 }}</span>
                      </div>
                      <div class="stat-item">
                        <span class="stat-label">Â§±Ë¥•</span>
                        <span class="stat-value error">{{ currentTask.strm_failed || 0 }}</span>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- ËµÑÊ∫êÊñá‰ª∂ËøõÂ∫¶Âç°Áâá -->
                <div class="progress-card resource">
                  <div class="progress-card-header">
                    <div class="progress-card-icon">
                      <n-icon size="24">
                        <Icon icon="mdi:file-download" />
                      </n-icon>
                    </div>
                    <div class="progress-card-title">
                      <h4>ËµÑÊ∫êÊñá‰ª∂</h4>
                      <span class="progress-card-subtitle">{{ (currentTask.resource_success || 0) + (currentTask.resource_failed || 0) }} / {{
                        currentTask.resource_files_count || 0 }} Êñá‰ª∂</span>
                    </div>
                    <div class="progress-card-percentage">
                      {{ getResourceProgressPercentage(currentTask) }}%
                    </div>
                  </div>
                  <div class="progress-card-body">
                    <SegmentedProgressBar
                      :success-count="currentTask.resource_success || 0"
                      :failed-count="currentTask.resource_failed || 0"
                      :total="currentTask.resource_files_count || 0"
                      :processing="currentTask.status === 'RUNNING'"
                      :height="8"
                      :border-radius="4"
                      success-color="#52c41a"
                      failed-color="#f5222d"
                      tooltip-title="ËµÑÊ∫êÊñá‰ª∂Â§ÑÁêÜËøõÂ∫¶"
                    />
                    <div class="progress-card-stats">
                      <div class="stat-item">
                        <span class="stat-label">ÊàêÂäü</span>
                        <span class="stat-value success">{{ currentTask.resource_success || 0 }}</span>
                      </div>
                      <div class="stat-item">
                        <span class="stat-label">Â§±Ë¥•</span>
                        <span class="stat-value error">{{ currentTask.resource_failed || 0 }}</span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>




            <!-- ‰ªªÂä°Êìç‰Ωú -->
            <div class="task-actions" v-if="['SUCCESS', 'COMPLETED'].includes(currentTask.status)">
              <h3 class="section-title">
                <n-icon>
                  <Icon icon="mdi:cog-play" />
                </n-icon>
                ‰ªªÂä°Êìç‰Ωú
              </h3>
              <div class="action-buttons">
                <n-button type="primary" size="large" @click="handleDownload(currentTask.id)">
                  <template #icon>
                    <n-icon>
                      <Icon icon="mdi:download" />
                    </n-icon>
                  </template>
                  ‰∏ãËΩΩÂ§ÑÁêÜÁªìÊûú
                </n-button>
                <n-button size="large" @click="openLogViewer(currentTask.id)">
                  <template #icon>
                    <n-icon>
                      <Icon icon="mdi:text-box" />
                    </n-icon>
                  </template>
                  Êü•ÁúãÂ§ÑÁêÜÊó•Âøó
                </n-button>
              </div>
            </div>

            <!-- Ë≠¶Âëä‰ø°ÊÅØ -->
            <n-alert v-if="currentTask && currentTask.total_files === 0" type="warning" class="mt-4">
              <template #icon>
                <n-icon>
                  <Icon icon="mdi:alert" />
                </n-icon>
              </template>
              <template #header>Êú™ÊâæÂà∞ÂèØÂ§ÑÁêÜÁöÑÊñá‰ª∂</template>
              ËØ∑Ê£ÄÊü•‰∏ä‰º†ÁöÑÊñá‰ª∂ÊòØÂê¶ÂåÖÂê´ËßÜÈ¢ëÊñá‰ª∂ÔºåÊàñÊ£ÄÊü•Á≥ªÁªüËÆæÁΩÆ‰∏≠ÁöÑÊñá‰ª∂Á±ªÂûãÈÖçÁΩÆÊòØÂê¶Ê≠£Á°Æ„ÄÇ
            </n-alert>
          </n-tab-pane>

          <n-tab-pane name="files" tab="üìÅ Êñá‰ª∂ÂàóË°®">
            <div v-if="!filesLoaded && !fileLoading" class="file-list-placeholder">
              <n-empty description="ÁÇπÂáªÂà∑Êñ∞ÊåâÈíÆÂä†ËΩΩÊñá‰ª∂ÂàóË°®">
                <template #icon>
                  <n-icon size="48" color="#d9d9d9">
                    <Icon icon="mdi:file-search-outline" />
                  </n-icon>
                </template>
                <template #extra>
                  <n-button type="primary" @click="() => fetchTaskFiles(currentTask?.id, 1, 10)">
                    <template #icon>
                      <n-icon>
                        <Icon icon="mdi:refresh" />
                      </n-icon>
                    </template>
                    Âä†ËΩΩÊñá‰ª∂ÂàóË°®
                  </n-button>
                </template>
              </n-empty>
            </div>
            <TaskFileList
              v-else
              :files="currentTask?.files || []"
              :loading="fileLoading"
              :total-count="fileListTotal"
              :current-page="fileListPage"
              :page-size="fileListPageSize"
              :task-id="currentTask?.id"
              :use-lazy-load="true"
              @file-click="handleFileClick"
              @refresh="() => fetchTaskFiles(currentTask?.id, fileListPage, fileListPageSize, currentFileFilters)"
              @page-change="handleFilePageChange"
              @page-size-change="handleFilePageSizeChange"
              @filter-change="handleFileFilterChange"
            />
          </n-tab-pane>
        </n-tabs>
      </div>
    </n-modal>

    <!-- Â¢ûÂº∫ÁöÑ‰ªªÂä°Êó•ÂøóÂØπËØùÊ°Ü -->
    <n-modal v-model:show="showTaskLogModal" preset="card" :title="logModalTitle" :bordered="false" size="huge"
      style="max-width: 1200px; width: 95vw; height: 95vh; max-height: 95vh;--n-padding-bottom:8px"
      :segmented="{ content: true }" class="task-log-modal">
      <div class="enhanced-task-logs-container">
        <!-- Êó•ÂøóËøáÊª§Âô® -->
        <EnhancedLogFilter v-model:filters="logFilters" @search="handleLogSearch" @reset="handleLogReset"
          @export="handleLogExport" />

        <!-- Êó•ÂøóÊü•ÁúãÂô® -->
        <div class="log-viewer-wrapper">
          <ConsoleLogViewer :logs="parsedLogLines" :searchTerm="logFilters.search"
            :levelFilter="logFilters.level || undefined" :showStats="false" :isRealTimeEnabled="isRealTimeEnabled"
            :logLoading="logLoading" :showRealTimeControls="true" @clear-logs="handleClearLogs"
            @toggle-real-time="toggleRealTimeUpdate" @refresh-logs="refreshLogs" />
        </div>

        <!-- Êó•ÂøóÂä†ËΩΩÁä∂ÊÄÅ -->
        <div v-if="logLoading" class="log-loading-overlay">
          <n-spin size="large">
            <template #description>
              Ê≠£Âú®Âä†ËΩΩÊó•ÂøóÊï∞ÊçÆ...
            </template>
          </n-spin>
        </div>
      </div>


    </n-modal>

    <!-- ËµÑÊ∫ê‰∏ãËΩΩ‰ªªÂä°ÂàõÂª∫ÂØπËØùÊ°ÜÂ∑≤ÁßªÈô§ -->
  </div>
</template>

<script setup lang="ts">
import { computed, h, onMounted, reactive, ref, watch, onUnmounted } from 'vue';
import { useClipboard } from '@vueuse/core';
import { useRouter } from 'vue-router';
import type { DataTableColumns, PaginationProps, SelectOption } from 'naive-ui';
import {
  NButton,
  NCard,
  NDataTable,
  NDatePicker,
  NEmpty,
  NGi,
  NGrid,
  NIcon,
  NInput,
  NModal,
  NPopconfirm,
  NProgress,
  NRadioButton,
  NRadioGroup,
  NSelect,
  NSpace,
  NStatistic,
  NSwitch,
  NTabPane,
  NTabs,
  NTag,
  NAlert,
  NTooltip,
  useMessage,
  useDialog
} from 'naive-ui';
import { Icon } from '@iconify/vue';
import dayjs from 'dayjs';
import {
  getTaskList,
  getTaskStatus,
  getTaskFiles,
  getStrmDownloadUrl,
  cancelTask,
  continueTask,
  deleteTask,
  getTaskLogs
} from '@/service/api/strm';
import { formatDate } from '@/utils/common';
import { useLogStream, filterLogs, analyzeLogStats, exportLogsToFile } from '@/composables/useLogStream';
import TaskStatusDisplay from '@/components/custom/task-status-display.vue';
import ConsoleLogViewer from '@/components/custom/console-log-viewer.vue';
import EnhancedLogFilter from '@/components/custom/enhanced-log-filter.vue';
import FileTreeView from '@/components/custom/file-tree-view.vue';
import SegmentedProgressBar from '@/components/custom/segmented-progress-bar.vue';
import TaskFileList from '@/components/strm/TaskFileList.vue';

defineOptions({
  name: 'StrmTasks'
});

const message = useMessage();
const dialog = useDialog();
const router = useRouter();

// ÂàùÂßãÂåñÂâ™Ë¥¥ÊùøÂäüËÉΩ
const { copy, isSupported } = useClipboard();
const loading = ref(false);
const tasksData = ref<any[]>([]);
const fileLoading = ref(false);

// Ëá™Âä®Âà∑Êñ∞Áõ∏ÂÖ≥Áä∂ÊÄÅ
const autoRefreshEnabled = ref(true); // ÈªòËÆ§ÂºÄÂêØ
const refreshInterval = ref(2); // Âà∑Êñ∞Èó¥ÈöîÔºàÁßíÔºâ
const refreshCountdown = ref(2); // ÂÄíËÆ°Êó∂ÁßíÊï∞
const refreshTimer = ref<NodeJS.Timeout | null>(null);
const countdownTimer = ref<NodeJS.Timeout | null>(null);

// Âà∑Êñ∞Èó¥ÈöîÈÄâÈ°π
const refreshIntervalOptions = [
  { label: '1Áßí', value: 1 },
  { label: '2Áßí', value: 2 },
  { label: '3Áßí', value: 3 },
  { label: '5Áßí', value: 5 },
  { label: '10Áßí', value: 10 },
  { label: '30Áßí', value: 30 }
];

// ÂÆûÊó∂Êó•ÂøóÊµÅ
const logStream = useLogStream();

// ‰ªªÂä°ËØ¶ÊÉÖÁõ∏ÂÖ≥
const showTaskDetailModal = ref(false);
const currentTask = ref<any>(null);
const activeTab = ref('overview');
const filesLoaded = ref(false);

// Êñá‰ª∂ÂàóË°®ÂàÜÈ°µÁä∂ÊÄÅ
const fileListPage = ref(1);
const fileListPageSize = ref(10); // Ë°®Ê†ºËßÜÂõæÈªòËÆ§10Êù°
const fileListTotal = ref(0);

// Êñá‰ª∂ÂàóË°®ËøáÊª§Áä∂ÊÄÅ
const currentFileFilters = ref<{ fileType?: string; search?: string; status?: boolean }>({});

// ‰ªªÂä°ÂàóË°®ÂàÜÈ°µÈÖçÁΩÆ
const pagination = reactive<PaginationProps>({
  page: 1,
  pageSize: 10,
  showSizePicker: true,
  pageSizes: [10, 20, 50, 100],
  itemCount: 0,
  prefix: ({ itemCount }) => `ÂÖ± ${itemCount} Êù°`,
  showQuickJumper: true
});

// Êñá‰ª∂ÂàóË°®ÂàÜÈ°µÈÖçÁΩÆ
const filePagination = reactive<PaginationProps>({
  page: 1,
  pageSize: 50,
  showSizePicker: true,
  pageSizes: [10, 20, 50, 100],
  itemCount: 0,
  prefix: ({ itemCount }) => `ÂÖ± ${itemCount} Êù°`,
  showQuickJumper: true
});

// ÊêúÁ¥¢ÂèÇÊï∞
const searchValue = ref('');
const dateRange = ref<[number, number] | null>(null);
const statusFilter = ref<string | null>(null);

// Áä∂ÊÄÅÈÄâÈ°π
const statusOptions: SelectOption[] = [
  { label: 'Á≠âÂæÖ‰∏≠', value: 'PENDING' },
  { label: 'Â§ÑÁêÜ‰∏≠', value: 'RUNNING' },
  { label: 'Â∑≤ÂÆåÊàê', value: 'SUCCESS' },
  { label: 'Â∑≤ÂèñÊ∂à', value: 'CANCELED' },
  { label: 'Â§±Ë¥•', value: 'FAILED' }
];

// Êó•ÊúüÂø´Êç∑ÈÄâÈ°π
const dateShortcuts = {
  '‰ªäÂ§©': () => {
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    const end = new Date();
    end.setHours(23, 59, 59, 999);
    return [today.getTime(), end.getTime()] as [number, number];
  },
  'Êò®Â§©': () => {
    const yesterday = new Date();
    yesterday.setDate(yesterday.getDate() - 1);
    yesterday.setHours(0, 0, 0, 0);
    const end = new Date();
    end.setDate(end.getDate() - 1);
    end.setHours(23, 59, 59, 999);
    return [yesterday.getTime(), end.getTime()] as [number, number];
  },
  'ÊúÄËøë7Â§©': () => {
    const start = new Date();
    start.setDate(start.getDate() - 6);
    start.setHours(0, 0, 0, 0);
    const end = new Date();
    end.setHours(23, 59, 59, 999);
    return [start.getTime(), end.getTime()] as [number, number];
  },
  'ÊúÄËøë30Â§©': () => {
    const start = new Date();
    start.setDate(start.getDate() - 29);
    start.setHours(0, 0, 0, 0);
    const end = new Date();
    end.setHours(23, 59, 59, 999);
    return [start.getTime(), end.getTime()] as [number, number];
  }
};

// ‰ªªÂä°Á±ªÂûãÁ≠õÈÄâÂ∑≤ÁßªÈô§ÔºåÊâÄÊúâ‰ªªÂä°Áªü‰∏Ä‰∏∫STRMÂ§ÑÁêÜ‰ªªÂä°
const taskTypeFilter = ref<string | null>(null);

// Ëé∑Âèñ‰ªªÂä°ÂàóË°®
const fetchTasks = async () => {
  loading.value = true;
  try {
    const params: Record<string, any> = {
      page: pagination.page,
      page_size: pagination.pageSize
    };

    // Ê∑ªÂä†ÊêúÁ¥¢Êù°‰ª∂
    if (searchValue.value) {
      params.search = searchValue.value;
    }

    // Ê∑ªÂä†Áä∂ÊÄÅËøáÊª§
    if (statusFilter.value) {
      params.status = statusFilter.value;
    }

    // Ê∑ªÂä†‰ªªÂä°Á±ªÂûãËøáÊª§
    if (taskTypeFilter.value) {
      params.task_type = taskTypeFilter.value;
    }

    // Ê∑ªÂä†Êó•ÊúüËåÉÂõ¥ËøáÊª§
    if (dateRange.value && Array.isArray(dateRange.value)) {
      const [start, end] = dateRange.value;
      if (start && end) {
        params.start_date = dayjs(start).format('YYYY-MM-DD');
        params.end_date = dayjs(end).format('YYYY-MM-DD 23:59:59');
      }
    }

    const response = await getTaskList(params);

    // Ê£ÄÊü•ÂìçÂ∫îÊ†ºÂºèÂπ∂ÊèêÂèñÊï∞ÊçÆ
    if (response) {
      let tasksArray = [];
      let totalCount = 0;

      // Ê£ÄÊü•ÊòØÂê¶ÊúâÂµåÂ•óÁöÑdataÂØπË±°ÔºàÊñ∞Ê†ºÂºèÔºâ
      if (response.data) {
        // Â¶ÇÊûúdata‰∏ãÊúâtasksÊï∞ÁªÑ
        if ((response.data as any).tasks && Array.isArray((response.data as any).tasks)) {
          tasksArray = (response.data as any).tasks;
          totalCount = (response.data as any).total || 0;
        }
        // Â¶ÇÊûúdataÊú¨Ë∫´Â∞±ÊòØ‰ªªÂä°Êï∞ÁªÑ
        else if (Array.isArray(response.data)) {
          tasksArray = response.data;
          totalCount = (response as any).total || 0;
        }
      }
      // Â¶ÇÊûúÁõ¥Êé•ÂåÖÂê´tasksÊï∞ÁªÑÔºàÊóßÊ†ºÂºèÔºâ
      else if ((response as any).tasks && Array.isArray((response as any).tasks)) {
        tasksArray = (response as any).tasks;
        totalCount = (response as any).total || 0;
      }
      // Â¶ÇÊûúresponseÊú¨Ë∫´Â∞±ÊòØ‰ªªÂä°Êï∞ÁªÑ
      else if (Array.isArray(response)) {
        tasksArray = response;
        totalCount = tasksArray.length;
      }

      if (tasksArray.length > 0) {
        // Ê†áÂáÜÂåñ‰ªªÂä°Êï∞ÊçÆ
        tasksData.value = tasksArray.map((task: any) => ({
          ...task,
          // Â¶ÇÊûúÂêéÁ´ØÊ≤°ÊúâÊèê‰æõtask_typeÂ≠óÊÆµÔºåÈªòËÆ§‰∏∫'strm'Á±ªÂûã
          task_type: task.task_type || 'strm',
          // Á°Æ‰øùÁä∂ÊÄÅÂ≠óÊÆµÁªü‰∏Ä‰∏∫Â§ßÂÜô
          status: task.status ? String(task.status).toUpperCase() : 'UNKNOWN'
        }));

        pagination.itemCount = totalCount;
      } else {
        tasksData.value = [];
        pagination.itemCount = 0;
      }
    } else {
      console.error('Ëé∑Âèñ‰ªªÂä°ÂàóË°®Â§±Ë¥•ÔºöÂìçÂ∫î‰∏∫Á©∫');
      message.error('Ëé∑Âèñ‰ªªÂä°ÂàóË°®Â§±Ë¥•ÔºöÂìçÂ∫î‰∏∫Á©∫');
      tasksData.value = [];
      pagination.itemCount = 0;
    }
  } catch (error: any) {
    console.error('Ëé∑Âèñ‰ªªÂä°ÂàóË°®Â§±Ë¥•', error);
    if (error.response?.data) {
      console.error('ÂìçÂ∫îÊï∞ÊçÆ:', error.response.data);
    }
    message.error(`Ëé∑Âèñ‰ªªÂä°ÂàóË°®Â§±Ë¥•: ${error.message || 'Êú™Áü•ÈîôËØØ'}`);
    tasksData.value = [];
    pagination.itemCount = 0;
  } finally {
    loading.value = false;
  }
};

// Ëé∑Âèñ‰ªªÂä°ËØ¶ÊÉÖ
const fetchTaskDetail = async (taskId: number) => {
  try {
    loading.value = true;
    const response = await getTaskStatus(taskId);

    // Ê£ÄÊü•Âπ∂ÊèêÂèñ‰ªªÂä°ËØ¶ÊÉÖ
    if (response) {
      console.log('=== APIÂìçÂ∫îÂÆåÊï¥Êï∞ÊçÆÁªìÊûÑ ===');
      console.log('response:', JSON.stringify(response, null, 2));
      console.log('response.data:', response.data);
      console.log('response.dataÁ±ªÂûã:', typeof response.data);

      // Ê£ÄÊü•ÊòØÂê¶ÊúâÂµåÂ•óÁöÑdataÂØπË±°
      if (response.data && typeof response.data === 'object' && !Array.isArray(response.data)) {
        currentTask.value = response.data;
        console.log('‰ªéresponse.dataÊèêÂèñ‰ªªÂä°ËØ¶ÊÉÖ');
      } else {
        currentTask.value = response;
        console.log('Áõ¥Êé•‰ΩøÁî®response‰Ωú‰∏∫‰ªªÂä°ËØ¶ÊÉÖ');
      }

      console.log('=== ÊèêÂèñÂêéÁöÑ‰ªªÂä°Êï∞ÊçÆ ===');
      console.log('currentTask.value:', JSON.stringify(currentTask.value, null, 2));

      // ËÆæÁΩÆÈªòËÆ§‰ªªÂä°Á±ªÂûã
      if (!currentTask.value.task_type) {
        currentTask.value.task_type = 'strm';
      }

      // Â∞ÜÁä∂ÊÄÅÊ†áÂáÜÂåñ‰∏∫Â§ßÂÜôÔºåÂπ∂Ê∑ªÂä†Ë∞ÉËØï‰ø°ÊÅØ
      console.log('ÂéüÂßã‰ªªÂä°Áä∂ÊÄÅ:', currentTask.value.status, 'Á±ªÂûã:', typeof currentTask.value.status);
      if (currentTask.value.status && typeof currentTask.value.status === 'string') {
        currentTask.value.status = currentTask.value.status.toUpperCase();
        console.log('Ê†áÂáÜÂåñÂêéÁöÑ‰ªªÂä°Áä∂ÊÄÅ:', currentTask.value.status);
      } else {
        console.warn('‰ªªÂä°Áä∂ÊÄÅ‰∏∫Á©∫ÊàñÈùûÂ≠óÁ¨¶‰∏≤Á±ªÂûã:', currentTask.value.status);
        // Â¶ÇÊûúÁä∂ÊÄÅ‰∏∫Á©∫ÊàñÊó†ÊïàÔºåËÆæÁΩÆÈªòËÆ§Áä∂ÊÄÅ
        currentTask.value.status = 'UNKNOWN';
      }

      // ÂØπ‰∏çÂêåÁ±ªÂûãÁöÑ‰ªªÂä°ÂèØËÉΩÈúÄË¶ÅÂÅö‰∏çÂêåÁöÑÂ§ÑÁêÜ
      if (currentTask.value.task_type === 'resource_download') {
        // ÁâπÊÆäÂ§ÑÁêÜËµÑÊ∫ê‰∏ãËΩΩ‰ªªÂä°ÁöÑËØ¶ÊÉÖ
        // ...
      }

      // Ê£ÄÊü•Êñá‰ª∂ÂàóË°®Â≠óÊÆµÁöÑÂêÑÁßçÂèØËÉΩ‰ΩçÁΩÆ
      console.log('=== Ê£ÄÊü•Êñá‰ª∂ÂàóË°®Â≠óÊÆµ ===');
      console.log('currentTask.valueÁöÑÊâÄÊúâÈîÆ:', Object.keys(currentTask.value));
      console.log('currentTask.value.files:', currentTask.value.files);
      console.log('currentTask.value.file_list:', currentTask.value.file_list);
      console.log('currentTask.value.processed_files:', currentTask.value.processed_files);
      console.log('currentTask.value.task_files:', currentTask.value.task_files);
      console.log('currentTask.value.strm_files:', currentTask.value.strm_files);

      // Â∞ùËØï‰ªé‰∏çÂêåÁöÑÂ≠óÊÆµËé∑ÂèñÊñá‰ª∂ÂàóË°®
      let filesList = null;
      const possibleFields = ['files', 'file_list', 'processed_files', 'task_files', 'strm_files', 'result_files'];

      for (const field of possibleFields) {
        if (currentTask.value[field] && Array.isArray(currentTask.value[field])) {
          filesList = currentTask.value[field];
          console.log(`‰ªé ${field} Â≠óÊÆµËé∑ÂèñÊñá‰ª∂ÂàóË°®ÔºåÊï∞Èáè:`, filesList.length);
          break;
        }
      }

      if (filesList && filesList.length > 0) {
        currentTask.value.files = filesList;
        console.log('Êñá‰ª∂ÂàóË°®Â≠òÂú®ÔºåÊï∞Èáè:', filesList.length);
        console.log('Êñá‰ª∂ÂàóË°®Á§∫‰æãÊï∞ÊçÆ:', filesList.slice(0, 2));
        filesLoaded.value = true;
      } else {
        console.warn('Êñá‰ª∂ÂàóË°®‰∏çÂ≠òÂú®Êàñ‰∏∫Á©∫ÔºåËÆæÁΩÆ‰∏∫Á©∫Êï∞ÁªÑ');
        currentTask.value.files = [];
        filesLoaded.value = false;
      }

      // ÈáçÁΩÆÊ†áÁ≠æÈ°µÁä∂ÊÄÅ
      activeTab.value = 'overview';

      // ÈáçÁΩÆÊñá‰ª∂ÂàóË°®ÂàÜÈ°µÁä∂ÊÄÅ
      fileListPage.value = 1;
      fileListPageSize.value = 10; // Ë°®Ê†ºËßÜÂõæÈªòËÆ§10Êù°
      fileListTotal.value = 0;
      // ÈáçÁΩÆËøáÊª§Áä∂ÊÄÅ
      currentFileFilters.value = {};

      showTaskDetailModal.value = true;
      console.log('‰ªªÂä°ËØ¶ÊÉÖËé∑ÂèñÂÆåÊàêÔºåÊñá‰ª∂ÂàóË°®Êï∞Èáè:', currentTask.value.files.length);
    } else {
      console.error('Ëé∑Âèñ‰ªªÂä°ËØ¶ÊÉÖÂ§±Ë¥•ÔºöÂìçÂ∫î‰∏∫Á©∫');
      message.error('Ëé∑Âèñ‰ªªÂä°ËØ¶ÊÉÖÂ§±Ë¥•ÔºöÂìçÂ∫î‰∏∫Á©∫');
    }
  } catch (error: any) {
    console.error('Ëé∑Âèñ‰ªªÂä°ËØ¶ÊÉÖÂ§±Ë¥•', error);
    if (error.response?.data) {
      console.error('ÂìçÂ∫îÊï∞ÊçÆ:', error.response.data);
    }
    message.error(`Ëé∑Âèñ‰ªªÂä°ËØ¶ÊÉÖÂ§±Ë¥•: ${error.message || 'Êú™Áü•ÈîôËØØ'}`);
  } finally {
    loading.value = false;
  }
};



// Â§ÑÁêÜÈ°µÁ†ÅÂèòÂåñ
const handlePageChange = (page: number) => {
  pagination.page = page;
  fetchTasks();
};

// Â§ÑÁêÜÊØèÈ°µÊï∞ÈáèÂèòÂåñ
const handlePageSizeChange = (pageSize: number) => {
  pagination.pageSize = pageSize;
  pagination.page = 1;
  fetchTasks();
};

// Â§ÑÁêÜÊêúÁ¥¢
const handleSearch = () => {
  pagination.page = 1;
  fetchTasks();
};

// Ê∏ÖÈô§Á≠õÈÄâÊù°‰ª∂
const clearFilters = () => {
  searchValue.value = '';
  dateRange.value = null;
  statusFilter.value = null;
  taskTypeFilter.value = null;
  handleSearch();
};

// Ë∑≥ËΩ¨Âà∞ÁîüÊàêÈ°µÈù¢
const goToGenerate = () => {
  router.push('/strm/generate');
};

// Ë∑≥ËΩ¨Âà∞‰ªªÂä°ÁöÑÁîüÊàêËøõÂ∫¶È°µÈù¢
const goToTaskProgress = (taskId: number) => {
  router.push(`/strm/generate?step=2&taskId=${taskId}`);
};

// Â§ÑÁêÜ‰∏ãËΩΩSTRMÊñá‰ª∂
const handleDownload = (taskId: number) => {
  const url = getStrmDownloadUrl(taskId);
  window.open(url, '_blank');
};

// Â§ÑÁêÜÂèñÊ∂à‰ªªÂä°
const handleCancelTask = async (taskId: number) => {
  try {
    await cancelTask(taskId);
    message.success('‰ªªÂä°Â∑≤ÂèñÊ∂à');
    fetchTasks();
  } catch (error: any) {
    message.error(`ÂèñÊ∂à‰ªªÂä°Â§±Ë¥•: ${error.message || 'Êú™Áü•ÈîôËØØ'}`);
  }
};

// Â§ÑÁêÜÂà†Èô§‰ªªÂä°
const handleDeleteTask = async (taskId: number) => {
  try {
    const response = await deleteTask(taskId);
    // ÊòæÁ§∫ÂêéÁ´ØËøîÂõûÁöÑËØ¶ÁªÜÊ∂àÊÅØ
    const successMessage = response?.data?.message || '‰ªªÂä°Â∑≤Âà†Èô§';
    message.success(successMessage);
    fetchTasks();
  } catch (error: any) {
    message.error(`Âà†Èô§‰ªªÂä°Â§±Ë¥•: ${error.message || 'Êú™Áü•ÈîôËØØ'}`);
  }
};

// Â§ÑÁêÜÁªßÁª≠‰ªªÂä°
const handleContinueTask = async (taskId: number) => {
  try {
    const response = await continueTask(taskId);
    // ÊòæÁ§∫ÂêéÁ´ØËøîÂõûÁöÑËØ¶ÁªÜÊ∂àÊÅØ
    const successMessage = response?.data?.message || '‰ªªÂä°Â∑≤ÁªßÁª≠';
    message.success(successMessage);
    fetchTasks();
  } catch (error: any) {
    message.error(`ÁªßÁª≠‰ªªÂä°Â§±Ë¥•: ${error.message || 'Êú™Áü•ÈîôËØØ'}`);
  }
};

// Ëé∑ÂèñÊÄª‰ΩìÊàêÂäüÊñá‰ª∂Êï∞ÔºàSTRM + ËµÑÊ∫êÊñá‰ª∂Ôºâ
const getTotalSuccessFiles = (task: any) => {
  if (!task) return 0;
  const strmSuccess = task.strm_success || 0;
  const resourceSuccess = task.resource_success || 0;
  return strmSuccess + resourceSuccess;
};

// Ëé∑ÂèñÊÄª‰ΩìÂ§±Ë¥•Êñá‰ª∂Êï∞ÔºàSTRM + ËµÑÊ∫êÊñá‰ª∂Ôºâ
const getTotalFailedFiles = (task: any) => {
  if (!task) return 0;
  const strmFailed = task.strm_failed || 0;
  const resourceFailed = task.resource_failed || 0;
  return strmFailed + resourceFailed;
};

// Ëé∑ÂèñÊÄª‰ΩìÂ∑≤Â§ÑÁêÜÊñá‰ª∂Êï∞ÔºàÊàêÂäü + Â§±Ë¥•Ôºâ
const getTotalProcessedFiles = (task: any) => {
  if (!task) return 0;
  return getTotalSuccessFiles(task) + getTotalFailedFiles(task);
};

// Ëé∑Âèñ‰ªªÂä°ÊÄª‰ΩìËøõÂ∫¶ÁôæÂàÜÊØî
const getTaskProgressPercentage = (task: any) => {
  if (!task) return 0;

  // ‰ºòÂÖà‰ΩøÁî®ÂêéÁ´ØËÆ°ÁÆóÁöÑËøõÂ∫¶ÔºàÂ∑≤‰øÆÂ§ç‰∏∫ÂåÖÂê´Â§±Ë¥•Êñá‰ª∂Ôºâ
  if (task.progress !== undefined && task.progress !== null) {
    return Math.round(task.progress);
  }

  // ÈôçÁ∫ßÂà∞ÂâçÁ´ØËÆ°ÁÆóÔºàÂÖºÂÆπÊóßÊï∞ÊçÆÔºâ- ÁªüËÆ°Â∑≤Â§ÑÁêÜÁöÑÊñá‰ª∂ÔºàÊàêÂäü+Â§±Ë¥•Ôºâ
  const total = task.total_files || 0;
  const processed = getTotalProcessedFiles(task);
  return total > 0 ? Math.round((processed / total) * 100) : 0;
};

// Ëé∑ÂèñSTRMÊñá‰ª∂ËøõÂ∫¶ÁôæÂàÜÊØî
const getStrmProgressPercentage = (task: any) => {
  if (!task) return 0;

  const total = task.strm_files_count || 0;
  const success = task.strm_success || 0;
  const failed = task.strm_failed || 0;

  // Â¶ÇÊûúÊ≤°ÊúâSTRMÊñá‰ª∂ÔºåËøîÂõû100%
  if (total === 0) return 100;

  // Âü∫‰∫éÂ∑≤Â§ÑÁêÜÊñá‰ª∂Êï∞ËÆ°ÁÆóËøõÂ∫¶ÔºàÊàêÂäü+Â§±Ë¥•Ôºâ
  const processed = success + failed;
  return total > 0 ? Math.round((processed / total) * 100) : 0;
};

// Ëé∑ÂèñËµÑÊ∫êÊñá‰ª∂ËøõÂ∫¶ÁôæÂàÜÊØî
const getResourceProgressPercentage = (task: any) => {
  if (!task) return 0;

  const total = task.resource_files_count || 0;
  const success = task.resource_success || 0;
  const failed = task.resource_failed || 0;

  // Â¶ÇÊûúÊ≤°ÊúâËµÑÊ∫êÊñá‰ª∂ÔºåËøîÂõû100%
  if (total === 0) return 100;

  // Âü∫‰∫éÂ∑≤Â§ÑÁêÜÊñá‰ª∂Êï∞ËÆ°ÁÆóËøõÂ∫¶ÔºàÊàêÂäü+Â§±Ë¥•Ôºâ
  const processed = success + failed;
  return total > 0 ? Math.round((processed / total) * 100) : 0;
};

// Ëé∑Âèñ‰ªªÂä°ËøõÂ∫¶ÁôæÂàÜÊØîÊñáÊú¨ÔºàÂ∏¶%Á¨¶Âè∑Ôºâ
const getTaskProgressText = (task: any) => {
  // ‰ΩøÁî®‰∏çÊç¢Ë°åÁ©∫Ê†º(\u00A0)ËøûÊé•Êï∞Â≠óÂíåÁôæÂàÜÊØîÁ¨¶Âè∑
  return `${getTaskProgressPercentage(task)}\u00A0%`;
};

// Ëé∑Âèñ‰ªªÂä°ËøõÂ∫¶Áä∂ÊÄÅ
const getTaskProgressStatus = (task: any): 'default' | 'success' | 'error' | 'warning' | 'info' => {
  const status = (task.status || '').toString().toUpperCase();

  // Â§ÑÁêÜ‰∏çÂêåÁöÑÁä∂ÊÄÅÊ†ºÂºè
  if (status === 'FAILED' || status === 'ERROR') return 'error';
  if (status === 'SUCCESS' || status === 'COMPLETED') return 'success';
  if (status === 'RUNNING' || status === 'PROCESSING' || status === 'IN_PROGRESS') return 'warning';
  if (status === 'CANCELED' || status === 'CANCELLED') return 'info';
  return 'default';
};

// Ëé∑Âèñ‰ªªÂä°Êñá‰ª∂ÂàóË°®
const fetchTaskFiles = async (
  taskId?: number,
  page?: number,
  pageSize?: number,
  filters?: { fileType?: string; search?: string; status?: boolean }
) => {
  if (!taskId && !currentTask.value?.id) return;

  const targetTaskId = taskId || currentTask.value!.id;
  const currentPage = page || fileListPage.value;
  const currentPageSize = pageSize || fileListPageSize.value;
  const currentFilters = filters || currentFileFilters.value;

  fileLoading.value = true;
  try {
    // ‰ΩøÁî®‰∏ìÈó®ÁöÑÊñá‰ª∂ÂàóË°®APIÔºåÊîØÊåÅÁúüÊ≠£ÁöÑÂêéÁ´ØÂàÜÈ°µÂíåËøáÊª§
    console.log(`[Êñá‰ª∂ÂàóË°®] ËØ∑Ê±ÇÂèÇÊï∞: taskId=${targetTaskId}, page=${currentPage}, pageSize=${currentPageSize}, filters=`, currentFilters);
    const response = await getTaskFiles(targetTaskId, currentPage, currentPageSize, currentFilters);

    if (response && response.data) {
      const { files, stats, pagination } = response.data;
      console.log(`[Êñá‰ª∂ÂàóË°®] APIÂìçÂ∫î: filesÊï∞Èáè=${files?.length}, pagination=`, pagination, 'stats=', stats);

      if (currentTask.value) {
        currentTask.value.files = files || [];
        // ‰ºòÂÖà‰ΩøÁî® pagination.total Â≠óÊÆµÔºåÂ¶ÇÊûúÊ≤°ÊúâÂàô‰ΩøÁî® stats.total
        fileListTotal.value = pagination?.total || stats?.total || 0;
        fileListPage.value = pagination?.page || currentPage;
        fileListPageSize.value = pagination?.page_size || currentPageSize;
        filesLoaded.value = true;
        console.log(`[Êñá‰ª∂ÂàóË°®] ËÆæÁΩÆÂÆåÊàê: fileListPageSize=${fileListPageSize.value}, filesÊï∞Èáè=${currentTask.value.files.length}`);
      }
    } else {
      console.warn('Êñá‰ª∂ÂàóË°®APIÂìçÂ∫î‰∏∫Á©∫');
      if (currentTask.value) {
        currentTask.value.files = [];
        fileListTotal.value = 0;
      }
    }
  } catch (error) {
    console.error('Ëé∑Âèñ‰ªªÂä°Êñá‰ª∂ÂàóË°®Â§±Ë¥•', error);
    if (currentTask.value) {
      currentTask.value.files = [];
      fileListTotal.value = 0;
    }
  } finally {
    fileLoading.value = false;
  }
};

// Ë°®Ê†ºÂàóÂÆö‰πâ
const columns: DataTableColumns<any> = [
  {
    title: 'ID',
    key: 'id',
    width: 80,
    align: 'center'
  },
  {
    title: '‰ªªÂä°ÂêçÁß∞',
    key: 'name',
    width: 300,
    ellipsis: {
      tooltip: true
    },
    align: 'center',
    render(row) {
      return h(
        NButton,
        {
          text: true,
          type: 'primary',
          onClick: () => goToTaskProgress(row.id),
          style: {
            padding: '0',
            height: 'auto',
            fontSize: '14px'
          }
        },
        { default: () => row.name || `‰ªªÂä° ${row.id}` }
      );
    }
  },
  {
    title: '‰ªªÂä°Á±ªÂûã',
    key: 'task_type',
    width: 120,
    align: 'center',
    render(row) {
      return h('span', {}, 'STRMÂ§ÑÁêÜ');
    }
  },
  {
    title: 'Áä∂ÊÄÅ',
    key: 'status',
    width: 120,
    align: 'center',
    render(row) {
      return h(TaskStatusDisplay, {
        status: row.status,
        task: row,
        taskType: row.task_type || 'strm'
      });
    }
  },
  {
    title: 'Â§ÑÁêÜËøõÂ∫¶',
    key: 'progress',
    width: 200,
    align: 'center',
    render(row) {
      const total = row.total_files || 0;
      // ‰ΩøÁî®ÊàêÂäüÊñá‰ª∂Êï∞ËÆ°ÁÆóËøõÂ∫¶ÔºàÂêéÁ´ØÂ∑≤Áªè‰øÆÊîπprocessed_files‰∏∫Âè™ÁªüËÆ°ÊàêÂäüÁöÑÔºâ
      const processed = row.processed_files || 0;
      const percentage = total ? Math.round((processed / total) * 100) : 0;

      let status: 'default' | 'success' | 'error' | 'warning' | 'info' = 'default';
      if (row.status === 'FAILED') {
        status = 'error';
      } else if (row.status === 'SUCCESS' || row.status === 'COMPLETED') {
        // Ê£ÄÊü•ÊòØÂê¶ÊúâÂ§±Ë¥•ÁöÑÊñá‰ª∂
        const failedFiles = row.failed_files || 0;
        const resourceFailed = row.resource_failed || 0;

        if (failedFiles > 0 || resourceFailed > 0) {
          status = 'warning'; // ÈÉ®ÂàÜÊàêÂäü
        } else {
          status = 'success'; // ÂÆåÂÖ®ÊàêÂäü
        }
      }

      return h('div', { class: 'flex flex-col items-center' }, [
        h(
          NProgress,
          {
            percentage,
            showIndicator: false,
            processing: row.status === 'RUNNING',
            type: 'line',
            status,
            style: 'width: 100%;'
          }
        ),
        h('div', { class: 'flex flex-col items-center mt-1' }, [
          h('span', { class: 'text-xs', style: 'white-space: nowrap;' }, `${percentage}%`),
          h('span', { class: 'text-xs text-gray-500' }, `${processed}/${total} Êñá‰ª∂`)
        ])
      ]);
    }
  },
  {
    title: 'ÂºÄÂßãÊó∂Èó¥',
    key: 'create_time',
    width: 180,
    align: 'center',
    render(row) {
      // ‰ΩøÁî®start_time‰Ωú‰∏∫ÂàõÂª∫Êó∂Èó¥ÁöÑÊï∞ÊçÆÊ∫ê
      const timeValue = row.start_time || row.create_time || row.created_at;
      return formatDate(timeValue);
    }
  },
  {
    title: 'Êìç‰Ωú',
    key: 'actions',
    width: 190,
    align: 'center',
    fixed: 'right',
    render(row: any) {
      return h(
        NSpace,
        { justify: "center" },
        {
          default: () => [
            // Êü•ÁúãÊåâÈíÆ
            h(
              NButton,
              {
                size: 'small',
                onClick: () => fetchTaskDetail(row.id),
              },
              { default: () => 'ËØ¶ÊÉÖ' }
            ),
            // Êó•ÂøóÊåâÈíÆ
            h(
              NButton,
              {
                size: 'small',
                onClick: () => openLogViewer(row.id),
                type: 'info',
              },
              { default: () => 'Êó•Âøó' }
            ),
            row.status === 'SUCCESS' ?
              h(
                NButton,
                {
                  size: 'small',
                  type: 'success',
                  onClick: () => handleDownload(row.id)
                },
                { default: () => '‰∏ãËΩΩ' }
              ) : null,
            row.status === 'PENDING' || row.status === 'RUNNING' ?
              h(
                NPopconfirm,
                {
                  onPositiveClick: () => handleCancelTask(row.id)
                },
                {
                  default: () => 'Á°ÆÂÆöË¶ÅÂèñÊ∂àÊ≠§‰ªªÂä°ÂêóÔºü',
                  trigger: () => h(
                    NButton,
                    {
                      size: 'small',
                      type: 'warning'
                    },
                    { default: () => 'ÂèñÊ∂à' }
                  )
                }
              ) : null,
            row.status === 'CANCELED' ?
              h(
                NPopconfirm,
                {
                  onPositiveClick: () => handleContinueTask(row.id)
                },
                {
                  default: () => 'Á°ÆÂÆöË¶ÅÁªßÁª≠Ê≠§‰ªªÂä°ÂêóÔºü',
                  trigger: () => h(
                    NButton,
                    {
                      size: 'small',
                      type: 'primary'
                    },
                    { default: () => 'ÁªßÁª≠' }
                  )
                }
              ) : null,
            h(
              NPopconfirm,
              {
                onPositiveClick: () => handleDeleteTask(row.id)
              },
              {
                default: () => 'Á°ÆÂÆöË¶ÅÂà†Èô§Ê≠§‰ªªÂä°ÂêóÔºü',
                trigger: () => h(
                  NButton,
                  {
                    size: 'small',
                    type: 'error'
                  },
                  { default: () => 'Âà†Èô§' }
                )
              }
            )
          ]
        }
      );
    }
  }
];



// Â§ÑÁêÜÊ†áÁ≠æÈ°µÂàáÊç¢
const handleTabChange = (tabName: string) => {
  activeTab.value = tabName;
  console.log('ÂàáÊç¢Âà∞Ê†áÁ≠æÈ°µ:', tabName);

  // Â¶ÇÊûúÂàáÊç¢Âà∞Êñá‰ª∂ÂàóË°®Ê†áÁ≠æÈ°µ‰∏îÊñá‰ª∂ÂàóË°®Â∞öÊú™Âä†ËΩΩÔºåÂàôÂä†ËΩΩÊñá‰ª∂ÂàóË°®
  if (tabName === 'files' && !filesLoaded.value && currentTask.value?.id) {
    // ÈáçÁΩÆÂàÜÈ°µÁä∂ÊÄÅ
    fileListPage.value = 1;
    fileListPageSize.value = 10; // Ë°®Ê†ºËßÜÂõæÈªòËÆ§10Êù°
    fileListTotal.value = 0;
    // ÈáçÁΩÆËøáÊª§Áä∂ÊÄÅ
    currentFileFilters.value = {};
    fetchTaskFiles(currentTask.value.id, 1, 10, {});
  }
};

// Êñá‰ª∂ÁÇπÂáªÂ§ÑÁêÜ
const handleFileClick = (file: any) => {
  console.log('Êñá‰ª∂ÁÇπÂáª:', file);
  // ËøôÈáåÂèØ‰ª•Ê∑ªÂä†Êñá‰ª∂ÁÇπÂáªÁöÑÂÖ∑‰ΩìÂ§ÑÁêÜÈÄªËæë
};

// Êñá‰ª∂ÂàóË°®ÂàÜÈ°µ‰∫ã‰ª∂Â§ÑÁêÜ
const handleFilePageChange = (page: number) => {
  fileListPage.value = page;
  fetchTaskFiles(currentTask.value?.id, page, fileListPageSize.value, currentFileFilters.value);
};

const handleFilePageSizeChange = (pageSize: number) => {
  fileListPageSize.value = pageSize;
  fileListPage.value = 1; // ÈáçÁΩÆÂà∞Á¨¨‰∏ÄÈ°µ
  fetchTaskFiles(currentTask.value?.id, 1, pageSize, currentFileFilters.value);
};

// Êñá‰ª∂ËøáÊª§Êù°‰ª∂ÂèòÂåñÂ§ÑÁêÜ
const handleFileFilterChange = (filters: { fileType?: string; search?: string; status?: string }) => {
  currentFileFilters.value = filters;
  fileListPage.value = 1; // ÈáçÁΩÆÂà∞Á¨¨‰∏ÄÈ°µ
  fetchTaskFiles(currentTask.value?.id, 1, fileListPageSize.value, filters);
};

// Êó•ÂøóÊü•ÁúãÁõ∏ÂÖ≥
const showTaskLogModal = ref(false);
const currentTaskId = ref<number | null>(null);
const logLoading = ref(false);
const logData = ref<any[]>([]);

// Êó•ÂøóËøáÊª§Âô®Áä∂ÊÄÅ
const logFilters = reactive({
  search: '',
  level: null as string | null,
  logType: null as string | null,
  timeRange: null as [number, number] | null,
  regex: '',
  exclude: ''
});

// Êó•ÂøóÁªüËÆ°‰ø°ÊÅØ
const logStats = reactive({
  total: 0,
  filtered: 0,
  info: 0,
  warning: 0,
  error: 0,
  debug: 0
});



// Êó•ÂøóÊ®°ÊÄÅÊ°ÜÊ†áÈ¢ò
const logModalTitle = computed(() => {
  const taskName = currentTask.value?.name || `‰ªªÂä°${currentTaskId.value}`;
  const status = isRealTimeEnabled.value ? ' (ÂÆûÊó∂Êõ¥Êñ∞)' : '';
  return `${taskName} - Êó•ÂøóËØ¶ÊÉÖ${status}`;
});

// ÂÆûÊó∂Êõ¥Êñ∞Áä∂ÊÄÅ
const isRealTimeEnabled = ref(false);

// Ëß£ÊûêÂêéÁöÑÊó•ÂøóË°åÊï∞ÊçÆ - Áî®‰∫éÊéßÂà∂Âè∞ÊòæÁ§∫
const parsedLogLines = computed(() => {
  // Â¶ÇÊûúÊ≤°ÊúâÊï∞ÊçÆÔºåËøîÂõûÁ©∫Êï∞ÁªÑ
  if (!logData.value || logData.value.length === 0) {
    return [];
  }

  // Â∞ÜÊó•ÂøóËÆ∞ÂΩïËΩ¨Êç¢‰∏∫Á∫ØÊñáÊú¨Ë°åÊ†ºÂºè
  let logs = logData.value.map(line => {
    // Â¶ÇÊûúÂ∑≤ÁªèÊòØÂ≠óÁ¨¶‰∏≤ÔºåÁõ¥Êé•ËøîÂõû
    if (typeof line === 'string') {
      return line;
    }

    // ÂÖºÂÆπÂ§ÑÁêÜÔºöÂ¶ÇÊûúÊòØÂØπË±°Ê†ºÂºèÔºåÂàôÊ†ºÂºèÂåñÔºà‰øùÁïôÂêëÂêéÂÖºÂÆπÊÄßÔºâ
    const timestamp = line.timestamp ? formatDate(line.timestamp, 'YYYY-MM-DD HH:mm:ss') : '';
    const level = line.level || 'INFO';
    const message = line.message || '';

    // ÊûÑÂª∫Êó•ÂøóË°å
    let logLine = `[${timestamp}] [${level}] ${message}`;

    // Ê∑ªÂä†Êñá‰ª∂Ë∑ØÂæÑ‰ø°ÊÅØÔºàÂ¶ÇÊûúÊúâÔºâ
    if (line.file_path) {
      logLine += ` | Êñá‰ª∂: ${line.file_path}`;
    }

    // Ê∑ªÂä†ÁõÆÊ†áË∑ØÂæÑ‰ø°ÊÅØÔºàÂ¶ÇÊûúÊúâÔºâ
    if (line.target_path) {
      logLine += ` | ÁõÆÊ†á: ${line.target_path}`;
    }

    // Ê∑ªÂä†ÈîôËØØ‰ø°ÊÅØÔºàÂ¶ÇÊûúÊúâÔºâ
    if (line.error_message) {
      logLine += ` | ÈîôËØØ: ${line.error_message}`;
    }

    // Ê∑ªÂä†Áä∂ÊÄÅ‰ø°ÊÅØÔºàÂ¶ÇÊûúÊúâÔºâ
    if (typeof line.is_success === 'boolean') {
      logLine += ` | Áä∂ÊÄÅ: ${line.is_success ? 'ÊàêÂäü' : 'Â§±Ë¥•'}`;
    }

    // ËøîÂõûÊó•ÂøóË°å
    return logLine;
  });

  // Â∫îÁî®ÂÆ¢Êà∑Á´ØËøáÊª§Âô®ÔºàÁî®‰∫éÂÆûÊó∂Êõ¥Êñ∞Êó∂ÁöÑÊú¨Âú∞ËøáÊª§Ôºâ
  if (logFilters.search || logFilters.level || logFilters.exclude || logFilters.regex) {
    logs = filterLogs(logs, {
      search: logFilters.search,
      level: logFilters.level || undefined,
      exclude: logFilters.exclude,
      regex: logFilters.regex,
      timeRange: logFilters.timeRange ? [
        new Date(logFilters.timeRange[0]),
        new Date(logFilters.timeRange[1])
      ] : undefined
    });

    // Êõ¥Êñ∞ËøáÊª§ÂêéÁöÑÁªüËÆ°‰ø°ÊÅØ
    logStats.filtered = logs.length;
  } else {
    logStats.filtered = logs.length;
  }

  return logs;
});

// Ëé∑Âèñ‰ªªÂä°Êó•Âøó
const fetchTaskLogs = async () => {
  if (!currentTaskId.value) return;

  logLoading.value = true;
  try {
    const params: Record<string, any> = {};

    // Ê∑ªÂä†ËøáÊª§ÂèÇÊï∞
    if (logFilters.search) {
      params.search = logFilters.search;
    }

    if (logFilters.level) {
      params.level = logFilters.level;
    }

    if (logFilters.logType) {
      params.log_type = logFilters.logType;
    }

    // Ê∑ªÂä†Êó∂Èó¥ËåÉÂõ¥ËøáÊª§
    if (logFilters.timeRange) {
      params.start_time = new Date(logFilters.timeRange[0]).toISOString();
      params.end_time = new Date(logFilters.timeRange[1]).toISOString();
    }

    const { data } = await getTaskLogs(currentTaskId.value, params);
    if (data) {
      // Â§ÑÁêÜÊó•ÂøóÂéüÂßãÂÜÖÂÆπ
      if (data.raw_content) {
        // ‰ªéraw_contentÂàÜÂâ≤Êó•ÂøóË°å
        const logLines = data.raw_content.split('\n')
          .filter((line: string) => line.trim() !== '')
          .map((line: string) => line);

        logData.value = logLines;

        // Êõ¥Êñ∞ÁªüËÆ°‰ø°ÊÅØ
        updateLogStats(logLines);
      } else {
        logData.value = [];
        resetLogStats();
      }
    }
  } catch (error: any) {
    message.error(`Ëé∑Âèñ‰ªªÂä°Êó•ÂøóÂ§±Ë¥•: ${error.message || 'Êú™Áü•ÈîôËØØ'}`);
    logData.value = [];
    resetLogStats();
  } finally {
    logLoading.value = false;
  }
};

// Êõ¥Êñ∞Êó•ÂøóÁªüËÆ°‰ø°ÊÅØ
const updateLogStats = (logs: string[]) => {
  logStats.total = logs.length;
  logStats.filtered = logs.length;
  logStats.info = 0;
  logStats.warning = 0;
  logStats.error = 0;
  logStats.debug = 0;

  logs.forEach(line => {
    if (line.includes('[INFO]')) {
      logStats.info++;
    } else if (line.includes('[WARNING]')) {
      logStats.warning++;
    } else if (line.includes('[ERROR]')) {
      logStats.error++;
    } else if (line.includes('[DEBUG]')) {
      logStats.debug++;
    }
  });
};

// ÈáçÁΩÆÊó•ÂøóÁªüËÆ°‰ø°ÊÅØ
const resetLogStats = () => {
  Object.assign(logStats, {
    total: 0,
    filtered: 0,
    info: 0,
    warning: 0,
    error: 0,
    debug: 0
  });
};

// Â§ÑÁêÜÊó•ÂøóÊêúÁ¥¢
const handleLogSearch = (filters?: any) => {
  if (filters) {
    Object.assign(logFilters, filters);
  }
  fetchTaskLogs();
};

// Â§ÑÁêÜÊó•ÂøóÈáçÁΩÆ
const handleLogReset = () => {
  Object.assign(logFilters, {
    search: '',
    level: null,
    logType: null,
    timeRange: null,
    regex: '',
    exclude: ''
  });
  fetchTaskLogs();
};

// Â§ÑÁêÜÊó•ÂøóÂØºÂá∫
const handleLogExport = async (filters?: any) => {
  if (!logData.value || logData.value.length === 0) {
    message.warning('ÊöÇÊó†Êó•ÂøóÂèØÂØºÂá∫');
    return;
  }

  try {
    const taskName = currentTask.value?.name || `‰ªªÂä°${currentTaskId.value}`;
    const fileName = `${taskName}_Êó•Âøó_${formatDate(new Date(), 'YYYY-MM-DD_HH-mm')}.txt`;

    // Â∫îÁî®ËøáÊª§Âô®Â§ÑÁêÜÊó•ÂøóÊï∞ÊçÆ
    let filteredLogs = [...logData.value];

    if (filters?.search) {
      filteredLogs = filteredLogs.filter(log =>
        log.toLowerCase().includes(filters.search.toLowerCase())
      );
    }

    if (filters?.level) {
      filteredLogs = filteredLogs.filter(log =>
        log.includes(`[${filters.level}]`)
      );
    }

    if (filters?.exclude) {
      filteredLogs = filteredLogs.filter(log =>
        !log.toLowerCase().includes(filters.exclude.toLowerCase())
      );
    }

    // ÂàõÂª∫ÂØºÂá∫ÂÜÖÂÆπ
    const exportContent = [
      `# ${taskName} Êó•ÂøóÂØºÂá∫`,
      `# ÂØºÂá∫Êó∂Èó¥: ${formatDate(new Date(), 'YYYY-MM-DD HH:mm:ss')}`,
      `# ÊÄªÊó•ÂøóÊï∞: ${logData.value.length}`,
      `# ÂØºÂá∫Êó•ÂøóÊï∞: ${filteredLogs.length}`,
      '',
      ...filteredLogs
    ].join('\n');

    // ÂàõÂª∫BlobÂØπË±°
    const blob = new Blob([exportContent], { type: 'text/plain;charset=utf-8' });

    // ÂàõÂª∫‰∏ãËΩΩÈìæÊé•
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = fileName;

    // ÁÇπÂáª‰∏ãËΩΩ
    document.body.appendChild(link);
    link.click();

    // Ê∏ÖÁêÜ
    document.body.removeChild(link);
    URL.revokeObjectURL(link.href);

    message.success(`Êó•ÂøóÂØºÂá∫ÊàêÂäüÔºåÂÖ±ÂØºÂá∫ ${filteredLogs.length} Êù°Êó•Âøó`);
  } catch (error) {
    message.error('Êó•ÂøóÂØºÂá∫Â§±Ë¥•');
  }
};

// Ê∏ÖÁ©∫Êó•Âøó
const handleClearLogs = () => {
  logData.value = [];
  resetLogStats();
  message.info('Êó•ÂøóÂ∑≤Ê∏ÖÁ©∫');
};

// Âà∑Êñ∞Êó•Âøó
const refreshLogs = () => {
  fetchTaskLogs();
};

// ÂàáÊç¢ÂÆûÊó∂Êõ¥Êñ∞
const toggleRealTimeUpdate = () => {
  if (!currentTaskId.value) return;

  if (isRealTimeEnabled.value) {
    // ÂÅúÊ≠¢ÂÆûÊó∂Êõ¥Êñ∞
    logStream.stopStream();
    isRealTimeEnabled.value = false;
    message.info('Â∑≤ÂÅúÊ≠¢ÂÆûÊó∂Êõ¥Êñ∞');
  } else {
    // ÂºÄÂßãÂÆûÊó∂Êõ¥Êñ∞
    logStream.startStream({
      taskId: currentTaskId.value,
      interval: 3000, // 3ÁßíÊõ¥Êñ∞‰∏ÄÊ¨°
      maxRetries: 5,
      onLogUpdate: (logs) => {
        logData.value = logs;
        updateLogStats(logs);
      },
      onError: (error) => {
        message.error(`ÂÆûÊó∂Êõ¥Êñ∞Â§±Ë¥•: ${error.message}`);
      }
    });
    isRealTimeEnabled.value = true;
    message.success('Â∑≤ÂºÄÂêØÂÆûÊó∂Êõ¥Êñ∞');
  }
};

// ÊâìÂºÄÊó•ÂøóÊü•ÁúãÂô®
const openLogViewer = (taskId: number) => {
  currentTaskId.value = taskId;

  // ÈáçÁΩÆËøáÊª§Âô®ÂíåÁªüËÆ°‰ø°ÊÅØÔºà‰∏çË∞ÉÁî®fetchTaskLogsÔºåÈÅøÂÖçÈáçÂ§çËØ∑Ê±ÇÔºâ
  Object.assign(logFilters, {
    search: '',
    level: null,
    logType: null,
    timeRange: null,
    regex: '',
    exclude: ''
  });
  resetLogStats();

  // ÂÅúÊ≠¢‰πãÂâçÁöÑÂÆûÊó∂Êõ¥Êñ∞
  if (isRealTimeEnabled.value) {
    logStream.stopStream();
    isRealTimeEnabled.value = false;
  }

  showTaskLogModal.value = true;
  // Âè™Ë∞ÉÁî®‰∏ÄÊ¨°fetchTaskLogs
  fetchTaskLogs();
};

// ÁõëÂê¨Êó•ÂøóÊ®°ÊÄÅÊ°ÜÂÖ≥Èó≠ÔºåÂÅúÊ≠¢ÂÆûÊó∂Êõ¥Êñ∞
watch(showTaskLogModal, (newValue) => {
  if (!newValue && isRealTimeEnabled.value) {
    // Ê®°ÊÄÅÊ°ÜÂÖ≥Èó≠Êó∂ÂÅúÊ≠¢ÂÆûÊó∂Êõ¥Êñ∞
    logStream.stopStream();
    isRealTimeEnabled.value = false;
  }
});

// ÁªÑ‰ª∂Âç∏ËΩΩÊó∂Ê∏ÖÁêÜ
onUnmounted(() => {
  if (isRealTimeEnabled.value) {
    logStream.stopStream();
  }
  // Ê∏ÖÁêÜËá™Âä®Âà∑Êñ∞ÂÆöÊó∂Âô®
  stopAutoRefresh();
});

// Ê†πÊçÆÊó•ÂøóÁ∫ßÂà´Ëé∑ÂèñÊ†áÁ≠æÁ±ªÂûã
const getLogLevelType = (level: string): 'success' | 'error' | 'warning' | 'info' | 'default' => {
  switch (level?.toUpperCase()) {
    case 'INFO':
      return 'info';
    case 'ERROR':
      return 'error';
    case 'WARNING':
      return 'warning';
    case 'DEBUG':
      return 'default';
    default:
      return 'default';
  }
};

// ÊóßÁöÑÂØºÂá∫Êó•ÂøóÂáΩÊï∞Ôºà‰øùÁïôÂÖºÂÆπÊÄßÔºâ
const exportLogs = () => {
  handleLogExport(logFilters);
};

// Ëá™Âä®Âà∑Êñ∞Áõ∏ÂÖ≥ÂáΩÊï∞
const startAutoRefresh = () => {
  if (!autoRefreshEnabled.value) return;

  // Ê∏ÖÈô§Áé∞ÊúâÂÆöÊó∂Âô®
  stopAutoRefresh();

  // ÂêØÂä®ÂÄíËÆ°Êó∂
  startCountdown();

  // ÂêØÂä®Âà∑Êñ∞ÂÆöÊó∂Âô®
  refreshTimer.value = setInterval(() => {
    if (autoRefreshEnabled.value) {
      fetchTasks().then(() => {
        // Âà∑Êñ∞ÂÆåÊàêÂêéÈáçÊñ∞ÂêØÂä®ÂÄíËÆ°Êó∂
        startCountdown();
      });
    } else {
      // Â¶ÇÊûúËá™Âä®Âà∑Êñ∞Ë¢´ÂÖ≥Èó≠ÔºåÂÅúÊ≠¢Âà∑Êñ∞
      stopAutoRefresh();
    }
  }, refreshInterval.value * 1000); // ‰ΩøÁî®ËÆæÂÆöÁöÑÈó¥ÈöîÊó∂Èó¥
};

const stopAutoRefresh = () => {
  if (refreshTimer.value) {
    clearInterval(refreshTimer.value);
    refreshTimer.value = null;
  }
  if (countdownTimer.value) {
    clearInterval(countdownTimer.value);
    countdownTimer.value = null;
  }
};

const startCountdown = () => {
  if (countdownTimer.value) {
    clearInterval(countdownTimer.value);
  }

  refreshCountdown.value = refreshInterval.value;
  countdownTimer.value = setInterval(() => {
    refreshCountdown.value--;
    if (refreshCountdown.value <= 0) {
      refreshCountdown.value = refreshInterval.value;
    }
  }, 1000);
};

const toggleAutoRefresh = (enabled: boolean) => {
  autoRefreshEnabled.value = enabled;
  if (enabled) {
    startAutoRefresh();
  } else {
    stopAutoRefresh();
  }
};

// Êõ¥Êñ∞Âà∑Êñ∞Èó¥Èöî
const updateRefreshInterval = (newInterval: number) => {
  refreshInterval.value = newInterval;
  refreshCountdown.value = newInterval;

  // Â¶ÇÊûúËá™Âä®Âà∑Êñ∞Ê≠£Âú®ËøêË°åÔºåÈáçÊñ∞ÂêØÂä®‰ª•Â∫îÁî®Êñ∞ÁöÑÈó¥Èöî
  if (autoRefreshEnabled.value && refreshTimer.value) {
    startAutoRefresh();
  }
};

// ÁªÑ‰ª∂ÊåÇËΩΩÊó∂Ëé∑ÂèñÊï∞ÊçÆ
onMounted(() => {
  fetchTasks().then(() => {
    // ÂàùÂßãÂä†ËΩΩÂÆåÊàêÂêéÔºåÂ¶ÇÊûúÂºÄÂêØ‰∫ÜËá™Âä®Âà∑Êñ∞ÔºåÂàôÂêØÂä®Ëá™Âä®Âà∑Êñ∞
    if (autoRefreshEnabled.value) {
      startAutoRefresh();
    }
  });
});

// Ê∑ªÂä†ËÆ°ÁÆóÂ§ÑÁêÜÊó∂ÈïøÁöÑËæÖÂä©ÂáΩÊï∞
const formatDuration = (seconds: number) => {
  if (seconds < 0) return '-'; // Â§ÑÁêÜÂºÇÂ∏∏ÊÉÖÂÜµ

  const days = Math.floor(seconds / 86400);
  const hours = Math.floor((seconds % 86400) / 3600);
  const minutes = Math.floor((seconds % 3600) / 60);
  const remainingSeconds = Math.floor(seconds % 60);

  if (days > 0) {
    return `${days}Â§©${hours}Â∞èÊó∂`;
  }

  if (hours > 0) {
    return `${hours}Â∞èÊó∂${minutes}ÂàÜÈíü`;
  }

  if (minutes > 0) {
    return `${minutes}ÂàÜÈíü${remainingSeconds}Áßí`;
  }

  // ÂΩìÊó∂Èó¥Â∑ÆÂ∞è‰∫é1Áßí‰ΩÜÂ§ß‰∫é0Êó∂ÔºåÊòæÁ§∫"‰∏çÂà∞1Áßí"ËÄå‰∏çÊòØ"0Áßí"
  if (seconds > 0 && remainingSeconds === 0) {
    return "‰∏çÂà∞1Áßí";
  }

  return `${remainingSeconds}Áßí`;
};

const isTaskProcessing = (task: any) => {
  return task.status === 'RUNNING';
};

// Ëé∑ÂèñÁä∂ÊÄÅÂõæÊ†á
const getStatusIcon = (status: string) => {
  // Á°Æ‰øùÁä∂ÊÄÅÂÄº‰∏∫Â§ßÂÜôÔºåÂπ∂Â§ÑÁêÜnullÊàñundefinedÊÉÖÂÜµ
  const normalizedStatus = (status || '').toUpperCase();

  const statusMap: Record<string, string> = {
    'PENDING': 'mdi:clock-outline',
    'RUNNING': 'mdi:cog-play',
    'PROCESSING': 'mdi:cog-play',
    'IN_PROGRESS': 'mdi:cog-play',
    'SUCCESS': 'mdi:check-circle',
    'COMPLETED': 'mdi:check-circle',
    'FAILED': 'mdi:close-circle',
    'ERROR': 'mdi:close-circle',
    'CANCELLED': 'mdi:cancel',
    'CANCELED': 'mdi:cancel',
    'UNKNOWN': 'mdi:help-circle'
  };
  return statusMap[normalizedStatus] || 'mdi:help-circle';
};

// Ëé∑ÂèñÁä∂ÊÄÅÊñáÊú¨
const getStatusText = (status: string) => {
  // Á°Æ‰øùÁä∂ÊÄÅÂÄº‰∏∫Â§ßÂÜôÔºåÂπ∂Â§ÑÁêÜnullÊàñundefinedÊÉÖÂÜµ
  const normalizedStatus = (status || '').toUpperCase();

  const statusMap: Record<string, string> = {
    'PENDING': 'Á≠âÂæÖ‰∏≠',
    'RUNNING': 'Â§ÑÁêÜ‰∏≠',
    'PROCESSING': 'Â§ÑÁêÜ‰∏≠',
    'IN_PROGRESS': 'Â§ÑÁêÜ‰∏≠',
    'SUCCESS': 'Â∑≤ÂÆåÊàê',
    'COMPLETED': 'Â∑≤ÂÆåÊàê',
    'FAILED': 'Â§ÑÁêÜÂ§±Ë¥•',
    'ERROR': 'Â§ÑÁêÜÂ§±Ë¥•',
    'CANCELLED': 'Â∑≤ÂèñÊ∂à',
    'CANCELED': 'Â∑≤ÂèñÊ∂à',
    'UNKNOWN': 'Êú™Áü•Áä∂ÊÄÅ'
  };
  return statusMap[normalizedStatus] || `${normalizedStatus || 'Êú™Áü•Áä∂ÊÄÅ'}`;
};

// Ëé∑ÂèñÁä∂ÊÄÅÊèèËø∞
const getStatusDescription = (status: string) => {
  // Á°Æ‰øùÁä∂ÊÄÅÂÄº‰∏∫Â§ßÂÜôÔºåÂπ∂Â§ÑÁêÜnullÊàñundefinedÊÉÖÂÜµ
  const normalizedStatus = (status || '').toUpperCase();

  const statusMap: Record<string, string> = {
    'PENDING': '‰ªªÂä°Ê≠£Âú®Á≠âÂæÖÁ≥ªÁªüËµÑÊ∫êÂàÜÈÖç',
    'RUNNING': '‰ªªÂä°Ê≠£Âú®Â§ÑÁêÜ‰∏≠ÔºåËØ∑ËÄêÂøÉÁ≠âÂæÖ',
    'PROCESSING': '‰ªªÂä°Ê≠£Âú®Â§ÑÁêÜ‰∏≠ÔºåËØ∑ËÄêÂøÉÁ≠âÂæÖ',
    'IN_PROGRESS': '‰ªªÂä°Ê≠£Âú®Â§ÑÁêÜ‰∏≠ÔºåËØ∑ËÄêÂøÉÁ≠âÂæÖ',
    'SUCCESS': 'ÊâÄÊúâÊñá‰ª∂Â∑≤ÊàêÂäüÂ§ÑÁêÜÂÆåÊàê',
    'COMPLETED': '‰ªªÂä°Â∑≤ÂÆåÊàêÔºåÂèØ‰ª•Êü•ÁúãÁªìÊûú',
    'FAILED': '‰ªªÂä°Â§ÑÁêÜËøáÁ®ã‰∏≠Âá∫Áé∞ÈîôËØØ',
    'ERROR': '‰ªªÂä°Â§ÑÁêÜËøáÁ®ã‰∏≠Âá∫Áé∞ÈîôËØØ',
    'CANCELLED': '‰ªªÂä°Â∑≤Ë¢´Áî®Êà∑ÊàñÁ≥ªÁªüÂèñÊ∂à',
    'CANCELED': '‰ªªÂä°Â∑≤Ë¢´Áî®Êà∑ÊàñÁ≥ªÁªüÂèñÊ∂à',
    'UNKNOWN': 'Êó†Ê≥ïËØÜÂà´ÁöÑ‰ªªÂä°Áä∂ÊÄÅÔºåËØ∑ËÅîÁ≥ªÁÆ°ÁêÜÂëò'
  };
  return statusMap[normalizedStatus] || `Áä∂ÊÄÅ‰ø°ÊÅØÊú™Áü• (${normalizedStatus || 'Á©∫'})`;
};

const getTaskDuration = (task: any) => {
  if (!task.start_time) return 'Â∞öÊú™ÂºÄÂßã';

  const start = new Date(task.start_time).getTime();

  // Â¶ÇÊûú‰ªªÂä°Â∑≤ÂÆåÊàêÔºåËÆ°ÁÆóÂºÄÂßãÂà∞ÁªìÊùüÁöÑÊó∂Èïø
  if (task.end_time) {
    const end = new Date(task.end_time).getTime();
    const duration = (end - start) / 1000; // ËΩ¨Êç¢‰∏∫Áßí
    return formatDuration(duration);
  }

  // Â¶ÇÊûú‰ªªÂä°Ê≠£Âú®ËøõË°å‰∏≠ÔºåËÆ°ÁÆóÂºÄÂßãÂà∞Áé∞Âú®ÁöÑÊó∂ÈïøÔºåÂπ∂Ê†áËÆ∞‰∏∫ËøõË°å‰∏≠
  if (isTaskProcessing(task)) {
    const now = new Date().getTime();
    const duration = (now - start) / 1000; // ËΩ¨Êç¢‰∏∫Áßí
    return `${formatDuration(duration)} (ËøõË°å‰∏≠)`;
  }

  return 'Â∞öÊú™ÂÆåÊàê';
};

// Ëé∑Âèñ‰ªªÂä°Á±ªÂûãÊòæÁ§∫ÂêçÁß∞
const getTaskTypeDisplay = (taskType: string) => {
  const typeMap: Record<string, string> = {
    'strm': 'STRMÂ§ÑÁêÜ‰ªªÂä°',
    'resource_download': 'ËµÑÊ∫ê‰∏ãËΩΩ‰ªªÂä°',
    'batch_process': 'ÊâπÈáèÂ§ÑÁêÜ‰ªªÂä°'
  };
  return typeMap[taskType] || 'STRMÂ§ÑÁêÜ‰ªªÂä°';
};

// Ê†ºÂºèÂåñÊñá‰ª∂Â§ßÂ∞è
const formatFileSize = (bytes: number) => {
  if (!bytes || bytes === 0) return '0 B';

  const units = ['B', 'KB', 'MB', 'GB', 'TB'];
  const k = 1024;
  const i = Math.floor(Math.log(bytes) / Math.log(k));

  return `${(bytes / Math.pow(k, i)).toFixed(i === 0 ? 0 : 1)} ${units[i]}`;
};



// Â§çÂà∂ËæìÂá∫ÁõÆÂΩïË∑ØÂæÑ
const copyOutputDir = async () => {
  if (!currentTask.value?.output_dir) {
    message.warning('Ê≤°ÊúâÂèØÂ§çÂà∂ÁöÑËæìÂá∫ÁõÆÂΩï');
    return;
  }

  if (!isSupported) {
    message.error('ÊÇ®ÁöÑÊµèËßàÂô®‰∏çÊîØÊåÅÂâ™Ë¥¥ÊùøÂäüËÉΩ');
    return;
  }

  const textToCopy = currentTask.value.output_dir;
  console.log('Â∞ùËØïÂ§çÂà∂ÊñáÊú¨:', textToCopy);

  try {
    await copy(textToCopy);
    console.log('ÊñáÊú¨:', textToCopy);
    message.success('ËæìÂá∫ÁõÆÂΩïË∑ØÂæÑÂ∑≤Â§çÂà∂Âà∞Ââ™Ë¥¥Êùø');
  } catch (error) {
    console.error('Â§çÂà∂Â§±Ë¥•:', error);
    message.error('Â§çÂà∂Â§±Ë¥•ÔºåËØ∑ÊâãÂä®Â§çÂà∂');

    // Â¶ÇÊûúÂ§çÂà∂Â§±Ë¥•ÔºåÊòæÁ§∫ÂØπËØùÊ°ÜËÆ©Áî®Êà∑ÊâãÂä®Â§çÂà∂
    showCopyModal(textToCopy);
  }
};



// ÊòæÁ§∫Â§çÂà∂Ê®°ÊÄÅÊ°Ü
const showCopyModal = (text: string) => {
  dialog.info({
    title: 'Â§çÂà∂ËæìÂá∫ÁõÆÂΩïË∑ØÂæÑ',
    content: `ËØ∑ÊâãÂä®Â§çÂà∂‰ª•‰∏ãË∑ØÂæÑÔºö\n\n${text}`,
    positiveText: 'Â∑≤Â§çÂà∂',
    onPositiveClick: () => {
      message.success('ÊÑüË∞¢Á°ÆËÆ§ÔºÅ');
    }
  });
};

// Ëé∑ÂèñÊñá‰ª∂ÂêçÔºà‰ªéË∑ØÂæÑ‰∏≠ÊèêÂèñÔºâ
const getFileName = (filePath: string) => {
  if (!filePath) return 'Êú™Áü•Êñá‰ª∂';
  const parts = filePath.split(/[/\\]/);
  return parts[parts.length - 1] || filePath;
};

// ËµÑÊ∫ê‰∏ãËΩΩ‰ªªÂä°ÂàõÂª∫ÂäüËÉΩÂ∑≤ÁßªÈô§ÔºåÁé∞Âú®ÊâÄÊúâ‰ªªÂä°ÈÄöËøáSTRMÂ§ÑÁêÜ‰ªªÂä°Áªü‰∏ÄÂ§ÑÁêÜ
</script>

<style scoped>
/* ‰ªªÂä°ËØ¶ÊÉÖÈ°µÈù¢Ê†∑Âºè */
.task-detail-container {
  display: flex;
  flex-direction: column;
  gap: 24px;
  padding: 0;
}

/* ‰ªªÂä°Â§¥ÈÉ®Ê†∑Âºè */
.task-detail-header {
  padding-bottom: 16px;
  border-bottom: 1px solid var(--n-border-color);
}

.task-header-main {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.task-title {
  display: flex;
  align-items: center;
  gap: 12px;
}

.task-icon {
  font-size: 24px;
  margin-right: 12px;
}

.task-name {
  font-size: 20px;
  font-weight: 600;
}

.task-meta {
  display: flex;
  align-items: center;
  gap: 16px;
}

.task-meta-actions {
  display: flex;
  align-items: center;
  gap: 12px;
}

.close-button {
  margin-left: 8px;
  transition: all 0.2s ease;
  font-size: 14px;
  font-weight: bold;
  color: #666;
}

.close-button:hover {
  background-color: rgba(0, 0, 0, 0.05);
  color: #333;
}

/* ‰ªªÂä°Áä∂ÊÄÅÊ®™ÂπÖ */
.task-status-banner {
  padding: 16px;
  border-radius: 8px;
  margin-bottom: 24px;
}

.status-content {
  display: flex;
  justify-content: space-between;
  align-items: center;
  gap: 16px;
}

.status-main {
  display: flex;
  align-items: center;
  gap: 16px;
}

.status-info {
  display: flex;
  flex-direction: column;
  gap: 4px;
}

.status-title {
  font-size: 18px;
  font-weight: 600;
}

.status-subtitle {
  font-size: 14px;
  opacity: 0.8;
}

.status-progress {
  min-width: 200px;
  max-width: 300px;
}

.progress-text {
  margin-top: 8px;
  font-size: 13px;
  text-align: center;
}

/* Áä∂ÊÄÅÈ¢úËâ≤ */
.status-pending {
  background-color: rgba(96, 125, 139, 0.1);
}

.status-running {
  background-color: rgba(24, 144, 255, 0.1);
}

.status-completed,
.status-success {
  background-color: rgba(82, 196, 26, 0.1);
}

.status-failed {
  background-color: rgba(245, 34, 45, 0.1);
}

.status-cancelled {
  background-color: rgba(250, 173, 20, 0.1);
}

.status-unknown {
  background-color: rgba(140, 140, 140, 0.1);
}

/* ÁªüËÆ°Âç°ÁâáÁΩëÊ†º */
.stats-grid {
  display: flex;
  flex-direction: column;
  gap: 24px;
  margin-bottom: 24px;
}

.stat-card-group {
  display: flex;
  flex-direction: column;
  gap: 16px;
  padding: 16px;
  border-radius: 8px;
  background-color: var(--n-card-color);
  border: 1px solid var(--n-border-color);
}

/* ‰ºòÂåñÁöÑÂúÜÂΩ¢ËøõÂ∫¶Êù°Âå∫ÂüüÊ†∑Âºè */
.optimized-progress-area {
  margin-bottom: 24px;
}

.circular-progress-container {
  padding: 16px 0;
}

/* Êñá‰ª∂ÁªüËÆ°‰∏éÂ§ÑÁêÜËøõÂ∫¶Ê†∑Âºè */
.progress-stats-section {
  margin-bottom: 24px;
}

.section-title {
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 18px;
  font-weight: 600;
  margin: 0 0 20px 0;
  color: var(--n-text-color);
}

.progress-stats-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(340px, 1fr));
  gap: 20px;
}

.progress-card {
  background: var(--n-card-color);
  border: 1px solid var(--n-border-color);
  border-radius: 12px;
  padding: 20px;
  transition: all 0.3s ease;
  position: relative;
  overflow: hidden;
}

.progress-card:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
}

.progress-card-header {
  display: flex;
  align-items: flex-start;
  gap: 16px;
  margin-bottom: 16px;
  min-width: 0;
  /* ÂÖÅËÆ∏flexÂ≠êÂÖÉÁ¥†Êî∂Áº© */
}

.progress-card-icon {
  display: flex;
  align-items: center;
  justify-content: center;
  width: 48px;
  height: 48px;
  border-radius: 12px;
  flex-shrink: 0;
}

.progress-card-title {
  flex: 1;
  min-width: 0;
  /* ÂÖÅËÆ∏Êî∂Áº© */
  overflow: hidden;
  /* Èò≤Ê≠¢ÂÜÖÂÆπÊ∫¢Âá∫ */
}

.progress-card-title h4 {
  margin: 0 0 4px 0;
  font-size: 16px;
  font-weight: 600;
  color: var(--n-text-color);
}

.progress-card-subtitle {
  font-size: 13px;
  color: var(--n-text-color-2);
}

.progress-card-percentage {
  font-size: 24px;
  font-weight: 700;
  color: var(--n-text-color);
  line-height: 1;
  white-space: nowrap;
  flex-shrink: 0;
  min-width: 60px;
  /* Á°Æ‰øùËÉΩÂÆπÁ∫≥"100%"ÁöÑÂÆΩÂ∫¶ */
  text-align: right;
  /* Âè≥ÂØπÈΩêÊòæÁ§∫ */
}

.progress-card-body {
  margin-top: 16px;
  white-space: nowrap;
}

.progress-card-stats {
  display: flex;
  justify-content: space-between;
  margin-top: 12px;
  gap: 16px;
}

.progress-card-stats .stat-item {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 4px;
}

.progress-card-stats .stat-label {
  font-size: 12px;
  color: var(--n-text-color-2);
  font-weight: 500;
}

.progress-card-stats .stat-value {
  font-size: 16px;
  font-weight: 600;
}

.progress-card-stats .stat-value.success {
  color: #52c41a;
}

.progress-card-stats .stat-value.error {
  color: #f5222d;
}

/* ‰∏çÂêåÁ±ªÂûãÂç°ÁâáÁöÑÂõæÊ†áÈ¢úËâ≤ */
.progress-card.overall .progress-card-icon {
  background: linear-gradient(135deg, rgba(114, 46, 209, 0.1), rgba(114, 46, 209, 0.2));
  color: #722ed1;
}

.progress-card.strm .progress-card-icon {
  background: linear-gradient(135deg, rgba(82, 196, 26, 0.1), rgba(82, 196, 26, 0.2));
  color: #52c41a;
}

.progress-card.resource .progress-card-icon {
  background: linear-gradient(135deg, rgba(24, 144, 255, 0.1), rgba(24, 144, 255, 0.2));
  color: #1890ff;
}

/* ÂìçÂ∫îÂºèÊ†∑Âºè */
@media (max-width: 768px) {
  .progress-stats-grid {
    grid-template-columns: 1fr;
    gap: 16px;
  }

  .progress-card-header {
    gap: 12px;
  }

  .progress-card-icon {
    width: 40px;
    height: 40px;
  }

  .progress-card-percentage {
    font-size: 20px;
  }

  .progress-card-stats {
    gap: 12px;
  }
}

@media (max-width: 480px) {
  .progress-card {
    padding: 16px;
  }

  .progress-card-header {
    flex-direction: row;
    align-items: flex-start;
    gap: 12px;
    flex-wrap: nowrap;
    /* Èò≤Ê≠¢Êç¢Ë°å */
  }

  .progress-card-icon {
    width: 40px;
    height: 40px;
  }

  .progress-card-percentage {
    font-size: 20px;
    white-space: nowrap;
    flex-shrink: 0;
    min-width: 50px;
    /* ÁßªÂä®Á´ØÁ®çÂ∞è‰∏Ä‰∫õ‰ΩÜ‰ªçËÉΩÂÆπÁ∫≥"100%" */
    text-align: right;
  }
}

/* ÈáçÊûÑÂêéÁöÑ‰ªªÂä°‰ø°ÊÅØÈÉ®ÂàÜ */
.task-info-section {
  margin-bottom: 32px;
}

/* Ê†áÈ¢òÂåÖË£ÖÂô® */
.section-title-wrapper {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 24px;
  padding-bottom: 16px;
  border-bottom: 2px solid var(--n-divider-color);
}

.section-title-wrapper .section-title {
  display: flex;
  align-items: center;
  gap: 12px;
  font-size: 20px;
  font-weight: 700;
  color: var(--n-text-color);
  margin: 0;
}

.title-icon-wrapper {
  display: flex;
  align-items: center;
  justify-content: center;
  width: 40px;
  height: 40px;
  border-radius: 12px;
  background: linear-gradient(135deg, rgba(24, 144, 255, 0.1), rgba(24, 144, 255, 0.2));
  color: #1890ff;
}

.task-status-badge {
  display: flex;
  align-items: center;
}

/* Â¢ûÂº∫ÁöÑ‰ø°ÊÅØÁΩëÊ†º */
.enhanced-info-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
  gap: 24px;
}

/* ‰ø°ÊÅØÂç°Áâá */
.info-card {
  background: var(--n-card-color);
  border: 1px solid var(--n-border-color);
  border-radius: 16px;
  padding: 24px;
  transition: all 0.3s ease;
  position: relative;
  overflow: hidden;
}

.info-card::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 4px;
  background: linear-gradient(90deg, transparent, var(--accent-color), transparent);
  opacity: 0;
  transition: opacity 0.3s ease;
}

.info-card:hover {
  transform: translateY(-4px);
  box-shadow: 0 12px 32px rgba(0, 0, 0, 0.1);
}

.info-card:hover::before {
  opacity: 1;
}

/* Âç°ÁâáÂ§¥ÈÉ® */
.card-header {
  display: flex;
  align-items: flex-start;
  gap: 16px;
  margin-bottom: 20px;
}

.card-icon {
  display: flex;
  align-items: center;
  justify-content: center;
  width: 48px;
  height: 48px;
  border-radius: 12px;
  flex-shrink: 0;
}

.card-title h4 {
  margin: 0 0 4px 0;
  font-size: 18px;
  font-weight: 600;
  color: var(--n-text-color);
}

.card-subtitle {
  font-size: 13px;
  color: var(--n-text-color-2);
  opacity: 0.8;
}

/* ‰∏çÂêåÁ±ªÂûãÂç°ÁâáÁöÑÊ†∑Âºè */
.primary-card {
  --accent-color: #722ed1;
}

.primary-icon {
  background: linear-gradient(135deg, rgba(114, 46, 209, 0.1), rgba(114, 46, 209, 0.2));
  color: #722ed1;
}

.time-card {
  --accent-color: #13c2c2;
}

.time-icon {
  background: linear-gradient(135deg, rgba(19, 194, 194, 0.1), rgba(19, 194, 194, 0.2));
  color: #13c2c2;
}

/* Âç°ÁâáÂÜÖÂÆπ */
.card-content {
  display: flex;
  flex-direction: column;
  gap: 16px;
}

/* ‰ø°ÊÅØË°å */
.info-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 12px 16px;
  background: var(--n-modal-color);
  border-radius: 10px;
  border: 1px solid var(--n-divider-color);
  transition: all 0.2s ease;
}

.info-row:hover {
  background: var(--n-hover-color);
  border-color: var(--accent-color);
}

.info-row.full-width {
  flex-direction: column;
  align-items: flex-start;
  gap: 8px;
}

.info-label {
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 14px;
  font-weight: 500;
  color: var(--n-text-color-2);
  min-width: 0;
}

.info-value {
  font-size: 14px;
  font-weight: 600;
  color: var(--n-text-color);
  text-align: right;
  min-width: 0;
}

.info-value.highlight {
  color: #722ed1;
  font-weight: 700;
}

.info-value.server-name {
  color: #52c41a;
  font-weight: 600;
}

.server-note {
  font-size: 12px;
  color: var(--n-text-color-3);
  font-weight: 400;
  margin-left: 8px;
}



.info-value.time-value {
  color: #fa8c16;
  font-weight: 600;
}

.info-value.duration-value {
  color: #1890ff;
  font-weight: 600;
}

.output-dir-container {
  display: flex;
  align-items: center;
  gap: 12px;
  width: 100%;
}

.path-input {
  flex: 1;
}

.path-input {
  cursor: pointer;
}

.path-input :deep(.n-input__input-el) {
  font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
  font-size: 13px;
  cursor: pointer;
  transition: all 0.2s ease;
}

.path-input:hover :deep(.n-input__input-el) {
  background: rgba(24, 144, 255, 0.05);
  border-color: #1890ff;
}

.path-input:active :deep(.n-input__input-el) {
  background: rgba(24, 144, 255, 0.1);
}

.info-value.path-value {
  word-break: break-all;
  text-align: left;
  font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
  font-size: 13px;
  background: rgba(0, 0, 0, 0.05);
  padding: 8px 12px;
  border-radius: 8px;
  flex: 1;
  overflow-x: auto;
  transition: all 0.2s ease;
  user-select: all;
}

.info-value.path-value.clickable {
  cursor: pointer;
  border: 1px solid transparent;
}

.info-value.path-value.clickable:hover {
  background: rgba(24, 144, 255, 0.1);
  border-color: #1890ff;
  transform: translateY(-1px);
  box-shadow: 0 2px 8px rgba(24, 144, 255, 0.2);
}

.info-value.path-value.clickable:active {
  transform: translateY(0);
  background: rgba(24, 144, 255, 0.15);
}

.copy-btn {
  flex-shrink: 0;
  font-size: 12px;
  padding: 4px 12px;
}

.info-value.server-url {
  color: #1890ff;
  font-weight: 600;
  font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
  font-size: 13px;
  word-break: break-all;
}

/* ÁæéÂåñÁöÑËæìÂá∫ÁõÆÂΩïÊ†∑Âºè */
.enhanced-output-dir {
  width: 100%;
  margin-top: 8px;
}

.path-display-container {
  display: flex;
  align-items: flex-start;
  gap: 12px;
  padding: 16px;
  background: linear-gradient(135deg, #f8faff 0%, #f0f7ff 100%);
  border: 1px solid #e1f0ff;
  border-radius: 12px;
  transition: all 0.3s ease;
  position: relative;
  overflow: hidden;
}

.path-display-container::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 3px;
  background: linear-gradient(90deg, #1890ff, #40a9ff, #69c0ff);
  opacity: 0;
  transition: opacity 0.3s ease;
}

.path-display-container:hover {
  border-color: #1890ff;
  box-shadow: 0 4px 16px rgba(24, 144, 255, 0.1);
  transform: translateY(-1px);
}

.path-display-container:hover::before {
  opacity: 1;
}

.path-icon {
  flex-shrink: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  width: 40px;
  height: 40px;
  background: rgba(24, 144, 255, 0.1);
  border-radius: 10px;
  margin-top: 2px;
}

.path-content {
  flex: 1;
  min-width: 0;
}

.path-text {
  font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
  font-size: 14px;
  font-weight: 500;
  color: #2c3e50;
  word-break: break-all;
  line-height: 1.5;
  margin-bottom: 12px;
  padding: 8px 12px;
  background: rgba(255, 255, 255, 0.8);
  border-radius: 8px;
  border: 1px solid rgba(24, 144, 255, 0.1);
  cursor: text;
  user-select: all;
}

.path-text:hover {
  background: rgba(255, 255, 255, 1);
  border-color: rgba(24, 144, 255, 0.3);
}

.path-actions {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
}

.copy-action,
.open-action {
  font-size: 12px;
  padding: 4px 8px;
  border-radius: 6px;
  transition: all 0.2s ease;
}

.copy-action:hover {
  background: rgba(24, 144, 255, 0.1);
  transform: translateY(-1px);
}

.open-action:hover {
  background: rgba(82, 196, 26, 0.1);
  transform: translateY(-1px);
}

.processing-status {
  animation: pulse 2s infinite;
}

@keyframes pulse {

  0%,
  100% {
    opacity: 1;
  }

  50% {
    opacity: 0.6;
  }
}



/* ÂìçÂ∫îÂºèËÆæËÆ° */
@media (max-width: 1200px) {
  .enhanced-info-grid {
    grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
    gap: 20px;
  }
}

@media (max-width: 768px) {
  .section-title-wrapper {
    flex-direction: column;
    align-items: flex-start;
    gap: 16px;
  }

  .enhanced-info-grid {
    grid-template-columns: 1fr;
    gap: 16px;
  }

  .info-card {
    padding: 20px;
  }

  .card-header {
    gap: 12px;
    margin-bottom: 16px;
  }

  .card-icon {
    width: 40px;
    height: 40px;
  }

  .card-title h4 {
    font-size: 16px;
  }

  .info-row {
    padding: 10px 12px;
  }

  .info-label {
    font-size: 13px;
  }

  .info-value {
    font-size: 13px;
  }

  /* ËæìÂá∫ÁõÆÂΩïÂìçÂ∫îÂºèÊ†∑Âºè */
  .path-display-container {
    padding: 12px;
    gap: 8px;
  }

  .path-icon {
    width: 32px;
    height: 32px;
  }

  .path-text {
    font-size: 12px;
    padding: 6px 8px;
    margin-bottom: 8px;
  }

  .path-actions {
    gap: 6px;
  }

  .copy-action,
  .open-action {
    font-size: 11px;
    padding: 3px 6px;
  }

}

@media (max-width: 480px) {
  .task-info-section {
    margin-bottom: 24px;
  }

  .section-title-wrapper {
    margin-bottom: 20px;
    padding-bottom: 12px;
  }

  .section-title-wrapper .section-title {
    font-size: 18px;
    gap: 10px;
  }

  .title-icon-wrapper {
    width: 36px;
    height: 36px;
  }

  .info-card {
    padding: 16px;
    border-radius: 12px;
  }

  .card-header {
    gap: 10px;
    margin-bottom: 12px;
  }

  .card-icon {
    width: 36px;
    height: 36px;
  }

  .card-title h4 {
    font-size: 15px;
  }

  .card-subtitle {
    font-size: 12px;
  }

  .info-row {
    padding: 8px 10px;
    border-radius: 8px;
  }

  .info-label {
    font-size: 12px;
  }

  .info-value {
    font-size: 12px;
  }

  .info-value.path-value {
    font-size: 11px;
  }


}





/* ‰ªªÂä°Êìç‰Ωú */
.task-actions {
  margin-bottom: 24px;
  padding: 16px;
  border-radius: 8px;
  background-color: var(--n-card-color);
  border: 1px solid var(--n-border-color);
}

.action-buttons {
  display: flex;
  gap: 12px;
  justify-content: center;
}



.text-success {
  color: #2ab85e;
}

.text-error {
  color: #f5222d;
}

.text-secondary-text {
  color: #8c8c8c;
}

.processing-status {
  color: #faad14;
  animation: pulse 2s infinite;
}

@keyframes pulse {
  0% {
    opacity: 0.6;
  }

  50% {
    opacity: 1;
  }

  100% {
    opacity: 0.6;
  }
}

/* ÂìçÂ∫îÂºèËÆæËÆ° */
@media (max-width: 768px) {
  .task-header-main {
    flex-direction: column;
    align-items: flex-start;
    gap: 12px;
  }

  .status-content {
    flex-direction: column;
    align-items: flex-start;
    gap: 12px;
  }

  .status-progress {
    min-width: 100%;
    max-width: 100%;
  }



  .info-grid {
    grid-template-columns: 1fr;
  }

  .action-buttons {
    flex-direction: column;
  }
}



.mb-4 {
  margin-bottom: 16px;
}

.mt-2 {
  margin-top: 8px;
}

.mr-1 {
  margin-right: 4px;
}

.text-center {
  text-align: center;
}

.text-lg {
  font-size: 18px;
}

.text-2xl {
  font-size: 24px;
}

.font-bold {
  font-weight: 700;
}

.font-medium {
  font-weight: 500;
}

.percent-text {
  font-size: 24px;
  font-weight: 700;
  white-space: nowrap;
  line-height: 1.2;
}

.no-wrap {
  white-space: nowrap;
}

.min-h-300px {
  min-height: 300px;
}

.tree-view-container {
  padding: 16px 0;
}

/* Â¢ûÂº∫ÁöÑÊó•ÂøóÁïåÈù¢Ê†∑Âºè */
.enhanced-task-logs-container {
  display: flex;
  flex-direction: column;
  height: calc(95vh - 80px);
  /* ÂáèÂéªÊ®°ÊÄÅÊ°ÜÂ§¥ÈÉ®ÁöÑÈ´òÂ∫¶ÔºåÊó†ÈúÄ‰∏∫Â∫ïÈÉ®footerÈ¢ÑÁïôÁ©∫Èó¥ */
  max-height: calc(95vh - 80px);
  gap: 8px;
  position: relative;
  width: 100%;
  max-width: 100%;
  overflow: hidden;
  box-sizing: border-box;
  padding: 0;
}

.log-viewer-wrapper {
  flex: 1;
  overflow: hidden;
  border-radius: 8px;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
  width: 100%;
  max-width: 100%;
  box-sizing: border-box;
  min-height: 0;
  display: flex;
  flex-direction: column;
  background: white;
  border: 1px solid #e8e8e8;
  height: 100%;
}

.log-loading-overlay {
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(255, 255, 255, 0.8);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 10;
  backdrop-filter: blur(4px);
}



/* ‰ªªÂä°Êó•ÂøóÊ®°ÊÄÅÊ°ÜÊ†∑Âºè */
.task-log-modal {
  display: flex;
  flex-direction: column;
  height: 90vh;
  max-height: 90vh;
}

.task-log-modal :deep(.n-card) {
  height: 100%;
  max-height: 100%;
  display: flex;
  flex-direction: column;
}

.task-log-modal :deep(.n-card__content) {
  flex: 1;
  overflow: hidden;
  padding: 16px !important;
  display: flex;
  flex-direction: column;
  min-height: 0;
}



.grid {
  display: grid;
}

.grid-cols-1 {
  grid-template-columns: repeat(1, minmax(0, 1fr));
}

.gap-4 {
  gap: 16px;
}

/* ÁªüËÆ°ÁΩëÊ†ºÂìçÂ∫îÂºèÊ†∑Âºè */
.stat-grid {
  display: grid;
  gap: 16px;
}

/* Â∞èÂ±èÂπïÔºö2Âàó */
@media (max-width: 767px) {
  .stat-grid {
    grid-template-columns: repeat(2, 1fr);
  }
}

/* ‰∏≠Á≠âÂ±èÂπïÔºö3Âàó */
@media (min-width: 768px) and (max-width: 1023px) {
  .stat-grid {
    grid-template-columns: repeat(3, 1fr);
  }

  .md\:grid-cols-2 {
    grid-template-columns: repeat(2, minmax(0, 1fr));
  }
}

/* Â§ßÂ±èÂπïÔºö6Âàó */
@media (min-width: 1024px) {
  .stat-grid {
    grid-template-columns: repeat(6, 1fr);
  }
}

/* Êñá‰ª∂ÂàóË°®Âç†‰ΩçÁ¨¶Ê†∑Âºè */
.file-list-placeholder {
  display: flex;
  align-items: center;
  justify-content: center;
  min-height: 300px;
  padding: 40px 20px;
}

/* Êó•ÂøóÊ®°ÊÄÅÊ°ÜÂìçÂ∫îÂºèËÆæËÆ° */
@media (max-width: 768px) {
  .enhanced-task-logs-container {
    gap: 12px;
  }

  .log-viewer-wrapper {
    border-radius: 4px;
  }
}

/* Á°Æ‰øùÊ®°ÊÄÅÊ°ÜÂÜÖÂÆπ‰∏ç‰ºöÊ∫¢Âá∫ */
.n-modal .n-card .n-card__content {
  overflow: hidden;
  max-width: 100%;
  box-sizing: border-box;
}

/* ÈíàÂØπÊó•ÂøóÊ®°ÊÄÅÊ°ÜÁöÑÁâπÊÆäÊ†∑Âºè */
.n-modal[style*="max-width: 1200px"] .n-card__content {
  padding: 16px;
  overflow: hidden;
}

/* Á°Æ‰øùÊó•ÂøóÊü•ÁúãÂô®ÁªÑ‰ª∂ÂÖÖÂàÜÂà©Áî®Á©∫Èó¥ */
.log-viewer-wrapper :deep(.enhanced-log-viewer) {
  height: 100%;
  min-height: 400px;
}

.log-viewer-wrapper :deep(.log-content-wrapper) {
  flex: 1;
  min-height: 300px;
}

.log-viewer-wrapper :deep(.console-mode) {
  min-height: 300px;
  max-height: none;
}

/* Ëá™Âä®Âà∑Êñ∞ÊéßÂà∂Ê†∑Âºè */
.auto-refresh-control {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 6px 12px;
  background: var(--n-card-color);
  border: 1px solid var(--n-border-color);
  border-radius: 6px;
  transition: all 0.3s ease;
}

.auto-refresh-control:hover {
  border-color: var(--n-primary-color);
  box-shadow: 0 2px 8px rgba(24, 144, 255, 0.1);
}

.refresh-status {
  display: flex;
  flex-direction: column;
  align-items: flex-start;
  gap: 2px;
  min-width: 60px;
}

.refresh-label {
  font-size: 12px;
  font-weight: 500;
  color: var(--n-text-color-2);
  line-height: 1;
}

.refresh-countdown {
  font-size: 11px;
  font-weight: 600;
  color: var(--n-primary-color);
  line-height: 1;
  animation: pulse-countdown 1s infinite;
}

.refresh-disabled {
  font-size: 11px;
  font-weight: 500;
  color: var(--n-text-color-3);
  line-height: 1;
}

@keyframes pulse-countdown {
  0%, 100% {
    opacity: 1;
  }
  50% {
    opacity: 0.6;
  }
}

/* ÂìçÂ∫îÂºèËÆæËÆ° */
@media (max-width: 768px) {
  .auto-refresh-control {
    padding: 4px 8px;
    gap: 6px;
  }

  .refresh-status {
    min-width: 50px;
  }

  .refresh-label {
    font-size: 11px;
  }

  .refresh-countdown,
  .refresh-disabled {
    font-size: 10px;
  }
}
</style>
